<!DOCTYPE html> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /><meta name=generator  content="Docutils 0.17.1: http://docutils.sourceforge.net/" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel=stylesheet > <style> body, input { font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif } code, kbd, pre { font-family: "Roboto Mono", "Courier New", Courier, monospace } </style> <link rel=stylesheet  href="../_static/stylesheets/application.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="../_static/fonts/material-icons.css"/> <meta name=theme-color  content="#2196f3"> <script src="../_static/javascripts/modernizr.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XX133829453-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-XX133829453-1'); </script> <title>Merging Spatial Data Sets &#8212; Practical Data Science</title> <link rel=stylesheet  type="text/css" href="../_static/pygments.css" /> <link rel=stylesheet  type="text/css" href="../_static/material.css" /> <script data-url_root="../" id=documentation_options  src="../_static/documentation_options.js"></script> <script src="../_static/jquery.js"></script> <script src="../_static/underscore.js"></script> <script src="../_static/doctools.js"></script> <script crossorigin=anonymous  integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script> <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script> <script defer=defer  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <link rel="shortcut icon" href="../_static/mids_logo.svg"/> <link rel=index  title=Index  href="../genindex.html" /> <link rel=search  title=Search  href="../search.html" /> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=blue> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#gis/gis_spatial_joins" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href="../index.html" title="Practical Data Science" class="md-header-nav__button md-logo"> <img src="../_static/mids_logo.svg" height=26  alt="Practical Data Science logo"> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >Practical Data Science</span> <span class=md-header-nav__topic > Merging Spatial Data Sets </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action="../search.html" method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=""Search"" autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <script src="../_static/javascripts/version_dropdown.js"></script> <script> var json_loc = "../"versions.json"", target_loc = "../../", text = "Versions"; $( document ).ready( add_version_dropdown(json_loc, target_loc, text)); </script> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href="../index.html" class=md-tabs__link >Home</a> <li class=md-tabs__item ><a href="../class_schedule.html" class=md-tabs__link >Class Schedule</a> <li class=md-tabs__item ><a href="../topic_list.html" class=md-tabs__link >Topic List</a> <li class=md-tabs__item ><a href="https://www.nickeubank.com" class=md-tabs__link >About The Author</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href="../index.html" title="Practical Data Science" class="md-nav__button md-logo"> <img src="../_static/mids_logo.svg" alt=" logo" width=48  height=48 > </a> <a href="../index.html" title="Practical Data Science">Practical Data Science</a> </label> <ul class=md-nav__list > <li class=md-nav__item > <a href="../class_schedule.html" class=md-nav__link >Class Schedule</a> <li class=md-nav__item > <a href="../autograder_guidelines.html" class=md-nav__link >Autograder Guidelines</a> <li class=md-nav__item > <a href="../not_a_mids_student.html" class=md-nav__link >Not a MIDS Student?</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <label class=md-nav__title  for=__toc >"Contents"</label> <ul class=md-nav__list  data-md-scrollfix=""> <li class=md-nav__item ><a href="#gis-gis-spatial-joins--page-root" class=md-nav__link >Merging Spatial Data Sets</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Regular-Merges" class=md-nav__link >Regular Merges</a> <li class=md-nav__item ><a href="#Spatial-Join" class=md-nav__link >Spatial Join</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Order-of-Join" class=md-nav__link >Order of Join</a> </ul> </nav> <li class=md-nav__item ><a href="#Nearest-Spatial-Join" class=md-nav__link >Nearest Spatial Join</a> <li class=md-nav__item ><a href="#Geometric-Manipulations" class=md-nav__link >Geometric Manipulations</a> </ul> </nav> </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <style> /* CSS for nbsphinx extension */ /* remove conflicting styling from Sphinx themes */ div.nbinput.container div.prompt *, div.nboutput.container div.prompt *, div.nbinput.container div.input_area pre, div.nboutput.container div.output_area pre, div.nbinput.container div.input_area .highlight, div.nboutput.container div.output_area .highlight { border: none; padding: 0; margin: 0; box-shadow: none; } div.nbinput.container > div[class*=highlight], div.nboutput.container > div[class*=highlight] { margin: 0; } div.nbinput.container div.prompt *, div.nboutput.container div.prompt * { background: none; } div.nboutput.container div.output_area .highlight, div.nboutput.container div.output_area pre { background: unset; } div.nboutput.container div.output_area div.highlight { color: unset; /* override Pygments text color */ } /* avoid gaps between output lines */ div.nboutput.container div[class*=highlight] pre { line-height: normal; } /* input/output containers */ div.nbinput.container, div.nboutput.container { display: -webkit-flex; display: flex; align-items: flex-start; margin: 0; width: 100%; } @media (max-width: 540px) { div.nbinput.container, div.nboutput.container { flex-direction: column; } } /* input container */ div.nbinput.container { padding-top: 5px; } /* last container */ div.nblast.container { padding-bottom: 5px; } /* input prompt */ div.nbinput.container div.prompt pre { color: #307FC1; } /* output prompt */ div.nboutput.container div.prompt pre { color: #BF5B3D; } /* all prompts */ div.nbinput.container div.prompt, div.nboutput.container div.prompt { width: 4.5ex; padding-top: 5px; position: relative; user-select: none; } div.nbinput.container div.prompt > div, div.nboutput.container div.prompt > div { position: absolute; right: 0; margin-right: 0.3ex; } @media (max-width: 540px) { div.nbinput.container div.prompt, div.nboutput.container div.prompt { width: unset; text-align: left; padding: 0.4em; } div.nboutput.container div.prompt.empty { padding: 0; } div.nbinput.container div.prompt > div, div.nboutput.container div.prompt > div { position: unset; } } /* disable scrollbars on prompts */ div.nbinput.container div.prompt pre, div.nboutput.container div.prompt pre { overflow: hidden; } /* input/output area */ div.nbinput.container div.input_area, div.nboutput.container div.output_area { -webkit-flex: 1; flex: 1; overflow: auto; } @media (max-width: 540px) { div.nbinput.container div.input_area, div.nboutput.container div.output_area { width: 100%; } } /* input area */ div.nbinput.container div.input_area { border: 1px solid #e0e0e0; border-radius: 2px; /*background: #f5f5f5;*/ } /* override MathJax center alignment in output cells */ div.nboutput.container div[class*=MathJax] { text-align: left !important; } /* override sphinx.ext.imgmath center alignment in output cells */ div.nboutput.container div.math p { text-align: left; } /* standard error */ div.nboutput.container div.output_area.stderr { background: #fdd; } /* ANSI colors */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-default-inverse-fg { color: #FFFFFF; } .ansi-default-inverse-bg { background-color: #000000; } .ansi-bold { font-weight: bold; } .ansi-underline { text-decoration: underline; } div.nbinput.container div.input_area div[class*=highlight] > pre, div.nboutput.container div.output_area div[class*=highlight] > pre, div.nboutput.container div.output_area div[class*=highlight].math, div.nboutput.container div.output_area.rendered_html, div.nboutput.container div.output_area > div.output_javascript, div.nboutput.container div.output_area:not(.rendered_html) > img{ padding: 5px; margin: 0; } /* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */ div.nbinput.container div.input_area > div[class^='highlight'], div.nboutput.container div.output_area > div[class^='highlight']{ overflow-y: hidden; } /* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */ .prompt .copybtn { display: none; } /* Some additional styling taken form the Jupyter notebook CSS */ .jp-RenderedHTMLCommon table, div.rendered_html table { border: none; border-collapse: collapse; border-spacing: 0; color: black; font-size: 12px; table-layout: fixed; } .jp-RenderedHTMLCommon thead, div.rendered_html thead { border-bottom: 1px solid black; vertical-align: bottom; } .jp-RenderedHTMLCommon tr, .jp-RenderedHTMLCommon th, .jp-RenderedHTMLCommon td, div.rendered_html tr, div.rendered_html th, div.rendered_html td { text-align: right; vertical-align: middle; padding: 0.5em 0.5em; line-height: normal; white-space: normal; max-width: none; border: none; } .jp-RenderedHTMLCommon th, div.rendered_html th { font-weight: bold; } .jp-RenderedHTMLCommon tbody tr:nth-child(odd), div.rendered_html tbody tr:nth-child(odd) { background: #f5f5f5; } .jp-RenderedHTMLCommon tbody tr:hover, div.rendered_html tbody tr:hover { background: rgba(66, 165, 245, 0.2); } </style> <section id=Merging-Spatial-Data-Sets > <h1 id=gis-gis-spatial-joins--page-root >Merging Spatial Data Sets<a class=headerlink  href="#gis-gis-spatial-joins--page-root" title="Permalink to this headline">¶</a></h1> <p>Like regular pandas DataFrames, GeoDataFrames can be merged with one another based on common merging variables. <em>Unlike</em> regular DataFrames, however, GeoDataFrames can also be merged based on spatial relationships using <em>spatial joins</em> with <code class="docutils literal notranslate"><span class=pre >sjoin</span></code> and <code class="docutils literal notranslate"><span class=pre >sjoin_nearest</span></code>.</p> <section id=Regular-Merges > <h2 id=Regular-Merges >Regular Merges<a class=headerlink  href="#Regular-Merges" title="Permalink to this headline">¶</a></h2> <p>Regular merges (on attributes) work with dataframes in the familiar way, <em>except</em> that the syntax is just a little different. In particular, to merge a GeoDataFrame <code class="docutils literal notranslate"><span class=pre >gdf</span></code> with a DataFrame <code class="docutils literal notranslate"><span class=pre >df</span></code>, you would type <code class="docutils literal notranslate"><span class=pre >gdf.merge(df,</span> <span class=pre >on="key")</span></code> instead of the familiar <code class="docutils literal notranslate"><span class=pre >pd.merge(gdf,</span> <span class=pre >df)</span></code>. This helps ensure that geopandas knows that you want to keep <code class="docutils literal notranslate"><span class=pre >gdf</span></code> as a geodataframe.</p> </section> <section id=Spatial-Join > <h2 id=Spatial-Join >Spatial Join<a class=headerlink  href="#Spatial-Join" title="Permalink to this headline">¶</a></h2> <p>The idea of a spatial join is that instead of joining rows across datasets based on common values of a variable, rows are joined based on spatial proximity. To illustrate, let’s being with two datasets: the dataset of countries we’ve been playing with already, and a dataset of cities:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[1]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >geopandas</span> <span class=k >as</span> <span class=nn >gpd</span>
<span class=n >world</span> <span class=o >=</span> <span class=n >gpd</span><span class=o >.</span><span class=n >read_file</span><span class=p >(</span><span class=n >gpd</span><span class=o >.</span><span class=n >datasets</span><span class=o >.</span><span class=n >get_path</span><span class=p >(</span><span class=s1 >'naturalearth_lowres'</span><span class=p >))</span>
<span class=n >world</span><span class=o >.</span><span class=n >plot</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[1]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
&lt;AxesSubplot:&gt;
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <img alt="../_images/gis_gis_spatial_joins_2_1.png" src="../_images/gis_gis_spatial_joins_2_1.png"/> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[2]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >world</span><span class=o >.</span><span class=n >sample</span><span class=p >(</span><span class=mi >3</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[2]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>pop_est <th>continent <th>name <th>iso_a3 <th>gdp_md_est <th>geometry <tr> <th>155 <td>126451398 <td>Asia <td>Japan <td>JPN <td>4932000.0 <td>MULTIPOLYGON (((141.88460 39.18086, 140.95949 ... <tr> <th>30 <td>11138234 <td>South America <td>Bolivia <td>BOL <td>78350.0 <td>POLYGON ((-69.52968 -10.95173, -68.78616 -11.0... <tr> <th>42 <td>591919 <td>South America <td>Suriname <td>SUR <td>8547.0 <td>POLYGON ((-54.52475 2.31185, -55.09759 2.52375... </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[3]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >cities</span> <span class=o >=</span> <span class=n >gpd</span><span class=o >.</span><span class=n >read_file</span><span class=p >(</span><span class=n >gpd</span><span class=o >.</span><span class=n >datasets</span><span class=o >.</span><span class=n >get_path</span><span class=p >(</span><span class=s1 >'naturalearth_cities'</span><span class=p >))</span>
<span class=n >cities</span><span class=o >.</span><span class=n >plot</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[3]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
&lt;AxesSubplot:&gt;
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <img alt="../_images/gis_gis_spatial_joins_4_1.png" src="../_images/gis_gis_spatial_joins_4_1.png"/> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[4]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >cities</span><span class=o >.</span><span class=n >sample</span><span class=p >(</span><span class=mi >5</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[4]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>name <th>geometry <tr> <th>27 <td>Bujumbura <td>POINT (29.36001 -3.37609) <tr> <th>23 <td>Djibouti <td>POINT (43.14800 11.59501) <tr> <th>134 <td>Ankara <td>POINT (32.86245 39.92918) <tr> <th>97 <td>Vientiane <td>POINT (102.59998 17.96669) <tr> <th>73 <td>Amman <td>POINT (35.93135 31.95197) </table> </div></div> </div> <p>In this toy city dataset, you will notice that we have cities’ names, but not the country in which they are located. Since we know this variable is in our <code class="docutils literal notranslate"><span class=pre >world</span></code> dataset, we can do a spatial join to match each city observation up with the country in which it is located:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[5]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >cities_w_county</span> <span class=o >=</span> <span class=n >cities</span><span class=o >.</span><span class=n >sjoin</span><span class=p >(</span><span class=n >world</span><span class=p >,</span> <span class=n >how</span><span class=o >=</span><span class=s2 >"left"</span><span class=p >,</span> <span class=n >predicate</span><span class=o >=</span><span class=s1 >'intersects'</span><span class=p >)</span>
<span class=n >cities_w_county</span><span class=o >.</span><span class=n >sample</span><span class=p >(</span><span class=mi >3</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[5]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>name_left <th>geometry <th>index_right <th>pop_est <th>continent <th>name_right <th>iso_a3 <th>gdp_md_est <tr> <th>189 <td>Cape Town <td>POINT (18.43304 -33.91807) <td>25.0 <td>54841552.0 <td>Africa <td>South Africa <td>ZAF <td>739100.0 <tr> <th>200 <td>Santiago <td>POINT (-70.66899 -33.44807) <td>10.0 <td>17789267.0 <td>South America <td>Chile <td>CHL <td>436100.0 <tr> <th>50 <td>Niamey <td>POINT (2.11471 13.51865) <td>55.0 <td>19245344.0 <td>Africa <td>Niger <td>NER <td>20150.0 </table> </div></div> </div> <p>Voilá! Just like that we’ve merged two datasets that have no variables in common.</p> <p>Note that like our regular merge/join methods, we can use <code class="docutils literal notranslate"><span class=pre >how</span></code> to dictate which observations remain in our joined dataset. Unlike a regular merge/join, though, we also have the argument <code class="docutils literal notranslate"><span class=pre >predicate</span></code> which dictates what spatial relationships should be merged. When merging points with polygons, there aren’t a lot of ways you can imagine rows relating to one another. But spatial joins can also be done with lines and polygons (say, matching roads with the states they cross), or with polygons and polygons (matching media markets to states), and in those settings you can imagine more complicated relationships. For example, perhaps we only want to join roads to states if the road lies entirely within the state; or perhaps we want to join our roads to any state they touch. To accommodate these different relationships, <code class="docutils literal notranslate"><span class=pre >predicate</span></code> accepts:</p> <ul class=simple > <li><p>intersects</p> <li><p>contains</p> <li><p>within</p> <li><p>touches</p> <li><p>crosses</p> <li><p>overlaps</p> </ul> <section id=Order-of-Join > <h3 id=Order-of-Join >Order of Join<a class=headerlink  href="#Order-of-Join" title="Permalink to this headline">¶</a></h3> <p>Note that while normal merge/join are symmetric – it doesn’t really matter which is the right dataset and which is left – order does matter for spatial joins, as only the <em>geometry</em> of one dataset is preserved. So if we do <code class="docutils literal notranslate"><span class=pre >cities.sjoin(world)</span></code>, the resulting geodataframe will be points (as above). But if we flip the order, we end up with country polygons:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[6]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >world</span><span class=o >.</span><span class=n >sjoin</span><span class=p >(</span><span class=n >cities</span><span class=p >)</span><span class=o >.</span><span class=n >plot</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[6]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
&lt;AxesSubplot:&gt;
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <img alt="../_images/gis_gis_spatial_joins_11_1.png" src="../_images/gis_gis_spatial_joins_11_1.png"/> </div> </div> </section> </section> <section id=Nearest-Spatial-Join > <h2 id=Nearest-Spatial-Join >Nearest Spatial Join<a class=headerlink  href="#Nearest-Spatial-Join" title="Permalink to this headline">¶</a></h2> <p><code class="docutils literal notranslate"><span class=pre >sjoin</span></code> is terrific for linking observations that are in the same location. But sometimes we’re interested not in joining records that are in exactly the same spot or are overlapping, but rather observations that are <em>near</em> to one another.</p> <p>For that, geopandas has <code class="docutils literal notranslate"><span class=pre >sjoin_nearest</span></code>. <code class="docutils literal notranslate"><span class=pre >sjoin_nearest</span></code>, as the name implies, merges an observation in one dataset to the <em>nearest</em> observation in another dataset.</p> <p>To illustrate, let’s find out what city is closest to the “middle” of each country (e.g. closest to each country’s centroid):</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[7]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >world</span><span class=p >[</span><span class=s2 >"centroids"</span><span class=p >]</span> <span class=o >=</span> <span class=n >world</span><span class=o >.</span><span class=n >centroid</span>
<span class=n >world</span> <span class=o >=</span> <span class=n >world</span><span class=o >.</span><span class=n >set_geometry</span><span class=p >(</span><span class=s2 >"centroids"</span><span class=p >)</span>
<span class=n >center_most_city</span> <span class=o >=</span> <span class=n >world</span><span class=o >.</span><span class=n >sjoin_nearest</span><span class=p >(</span><span class=n >cities</span><span class=p >,</span> <span class=n >how</span><span class=o >=</span><span class=s2 >"inner"</span><span class=p >)</span>
<span class=n >center_most_city</span> <span class=o >=</span> <span class=n >center_most_city</span><span class=o >.</span><span class=n >rename</span><span class=p >(</span>
    <span class=p >{</span><span class=s2 >"name_right"</span><span class=p >:</span> <span class=s2 >"centermost_city"</span><span class=p >},</span> <span class=n >axis</span><span class=o >=</span><span class=s2 >"columns"</span>
<span class=p >)</span>
<span class=n >center_most_city</span><span class=o >.</span><span class=n >sample</span><span class=p >(</span><span class=mi >3</span><span class=p >)</span>
<br/></pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area stderr docutils container"> <div class=highlight ><pre>
/var/folders/tj/s8f2_ks15h315z5thvtnhz8r0000gp/T/ipykernel_40833/416860634.py:1: UserWarning: Geometry is in a geographic CRS. Results from 'centroid' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

  world["centroids"] = world.centroid
/Users/Nick/opt/miniconda3/lib/python3.9/site-packages/geopandas/array.py:341: UserWarning: Geometry is in a geographic CRS. Results from 'sjoin_nearest' are likely incorrect. Use 'GeoSeries.to_crs()' to re-project geometries to a projected CRS before this operation.

  warnings.warn(
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[7]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>pop_est <th>continent <th>name_left <th>iso_a3 <th>gdp_md_est <th>geometry <th>centroids <th>index_right <th>centermost_city <tr> <th>171 <td>2103721 <td>Europe <td>Macedonia <td>MKD <td>29520.0 <td>POLYGON ((22.38053 42.32026, 22.88137 41.99930... <td>POINT (21.69790 41.60593) <td>25 <td>Skopje <tr> <th>157 <td>28036829 <td>Asia <td>Yemen <td>YEM <td>73450.0 <td>POLYGON ((52.00001 19.00000, 52.78218 17.34974... <td>POINT (47.53504 15.91323) <td>136 <td>Sanaa <tr> <th>43 <td>67106161 <td>Europe <td>France <td>-99 <td>2699000.0 <td>MULTIPOLYGON (((-51.65780 4.15623, -52.24934 3... <td>POINT (-2.87670 42.46070) <td>166 <td>Madrid </table> </div></div> </div> <p>(Note we’re getting those same errors about calculating distances using a “geographic CRS” we got before. Once again, geopandas is telling us something important, and I <strong>definitely</strong> wouldn’t ignore these warnings in a real analysis. I just want to put off discussion of projections till a <a class="reference external" href=gis_projections_and_crs.ipynb >future reading</a>.)</p> <p>Voilá! Obviously this isn’t the <em>most</em> compelling illustrative example, but you could easily see how this might be helpful for, say, finding the supply depots closest to each store, the polling place closest to each voter, etc.</p> </section> <section id=Geometric-Manipulations > <h2 id=Geometric-Manipulations >Geometric Manipulations<a class=headerlink  href="#Geometric-Manipulations" title="Permalink to this headline">¶</a></h2> <p>As we saw above, geopandas has utilities (like <code class="docutils literal notranslate"><span class=pre >.centroid</span></code>) for manipulating the geometric objects. The <a class="reference external" href="https://geopandas.org/en/stable/docs/user_guide/geometric_manipulations.html">full like of supported manipulations can be found here</a>, but some of the most useful are:</p> <ul class=simple > <li><p>generating centroids (<code class="docutils literal notranslate"><span class=pre >.centroid</span></code>),</p> <li><p>calculating geometric properties like area or length (<code class="docutils literal notranslate"><span class=pre >.area</span></code> and <code class="docutils literal notranslate"><span class=pre >.length</span></code>), and</p> <li><p>dissolving all the distinct geometries in a geodataframe into a single shape (<code class="docutils literal notranslate"><span class=pre >.unary_union</span></code>).</p> </ul> <p>Perhaps the most useful for relating data, though, is <code class="docutils literal notranslate"><span class=pre >.buffer()</span></code>. Buffer takes a set of points and converts them into circular polygons of a given radius. This is <em>extremely</em> useful if you, say, want to do a spatial join to find all the observations in another dataset that are within a given distance of your original points.</p> <p>To illustrate, suppose you wanted to find all the cities within 500 kilometers of each city in our <code class="docutils literal notranslate"><span class=pre >cities</span></code> dataset – how would you do it?</p> <p>Well, we can start by using <code class="docutils literal notranslate"><span class=pre >.buffer()</span></code> to create a new GeoDataFrame with circular polygons instead of points. Then we can do a spatial join of that new GeoDataFrame with our original cities GeoDataFrame to find all the cities that intersect each city’s 500 km circle.</p> <p>Note that to do this, I <em>do</em> have to play with the projection of our data a little. As we found before, our data is currently represented by x-y coordinates written in terms of degrees of latitude and longitude. But to create a buffer of 500 kilometers, we need to first move to a projection where the units are in meters, which I can do with <code class="docutils literal notranslate"><span class=pre >.to_crs()</span></code>:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[8]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >cities_reprojected</span> <span class=o >=</span> <span class=n >cities</span><span class=o >.</span><span class=n >to_crs</span><span class=p >(</span><span class=s2 >"+proj=cea +lon_0=0 +lat_ts=45 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"</span><span class=p >)</span>
<span class=n >cities_reprojected</span><span class=o >.</span><span class=n >plot</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[8]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
&lt;AxesSubplot:&gt;
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <img alt="../_images/gis_gis_spatial_joins_17_1.png" src="../_images/gis_gis_spatial_joins_17_1.png"/> </div> </div> <p>And now we can do our buffer and join:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[9]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Create circular polygons with buffer</span>
<span class=n >cities_reprojected</span><span class=p >[</span><span class=s2 >"buffers"</span><span class=p >]</span> <span class=o >=</span> <span class=n >cities_reprojected</span><span class=o >.</span><span class=n >buffer</span><span class=p >(</span><span class=mi >500_000</span><span class=p >)</span>

<span class=c1 ># Make the buffers the "official geometry"</span>
<span class=n >city_buffers</span> <span class=o >=</span> <span class=n >cities_reprojected</span><span class=o >.</span><span class=n >set_geometry</span><span class=p >(</span><span class=s2 >"buffers"</span><span class=p >)</span>
<span class=n >city_buffers</span><span class=o >.</span><span class=n >plot</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[9]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
&lt;AxesSubplot:&gt;
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <img alt="../_images/gis_gis_spatial_joins_19_1.png" src="../_images/gis_gis_spatial_joins_19_1.png"/> </div> </div> <p>I know that plot looks very similar to the one above, but that’s just an illusion of the plots – the plot we created before buffering turned our points into circles to help visualize them, but from the perspective of geopandas, they’re just points with zero area. Now that we’ve buffered them, however, they’re actually polygons with diameters of 500 kilometers:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[10]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >city_buffers</span><span class=o >.</span><span class=n >sample</span><span class=p >(</span><span class=mi >3</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[10]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>name <th>geometry <th>buffers <tr> <th>113 <td>Cotonou <td>POINT (198539.858 997409.897) <td>POLYGON ((698539.858 997409.897, 696132.222 94... <tr> <th>39 <td>Ashgabat <td>POINT (4603338.357 5510032.486) <td>POLYGON ((5103338.357 5510032.486, 5100930.721... <tr> <th>60 <td>Honiara <td>POINT (12611532.802 -1466922.188) <td>POLYGON ((13111532.802 -1466922.188, 13109125.... </table> </div></div> </div> <p>With areas of <span class="math notranslate nohighlight">\(500,000^2 \pi = 7.85 * 10^{11}\)</span> meters squared:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[11]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >city_buffers</span><span class=o >.</span><span class=n >sample</span><span class=p >(</span><span class=mi >3</span><span class=p >)</span><span class=o >.</span><span class=n >area</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[11]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
149    7.841371e+11
52     7.841371e+11
167    7.841371e+11
dtype: float64
</pre></div></div> </div> <p>So now we can do a spatial join of these circular polygons with our city points, and any cities that intersect with these buffers will be matched up, giving us a dataset of cities and their neighbors!</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[12]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Now join the polygons with our points</span>
<span class=n >joined</span> <span class=o >=</span> <span class=n >cities_reprojected</span><span class=o >.</span><span class=n >sjoin</span><span class=p >(</span><span class=n >city_buffers</span><span class=p >[[</span><span class=s2 >"name"</span><span class=p >,</span> <span class=s2 >"buffers"</span><span class=p >]])</span>
<span class=n >joined</span><span class=o >.</span><span class=n >sample</span><span class=p >(</span><span class=mi >5</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[12]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>name_left <th>geometry <th>buffers <th>index_right <th>name_right <tr> <th>4 <td>Palikir <td>POINT (12469624.946 1077231.960) <td>POLYGON ((12969624.946 1077231.960, 12967217.3... <td>4 <td>Palikir <tr> <th>87 <td>Tallinn <td>POINT (1949727.750 7727330.615) <td>POLYGON ((2449727.750 7727330.615, 2447320.113... <td>154 <td>Helsinki <tr> <th>86 <td>Zagreb <td>POINT (1261548.941 6427274.597) <td>POLYGON ((1761548.941 6427274.597, 1759141.304... <td>86 <td>Zagreb <tr> <th>192 <td>Rome <td>POINT (984111.993 5985209.844) <td>POLYGON ((1484111.993 5985209.844, 1481704.357... <td>16 <td>Ljubljana <tr> <th>21 <td>Pristina <td>POINT (1668870.870 6074546.314) <td>POLYGON ((2168870.870 6074546.314, 2166463.233... <td>137 <td>Bucharest </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[13]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Cleanup columns</span>
<span class=n >joined</span> <span class=o >=</span> <span class=n >joined</span><span class=o >.</span><span class=n >rename</span><span class=p >(</span>
    <span class=p >{</span><span class=s2 >"name_left"</span><span class=p >:</span> <span class=s2 >"city_name"</span><span class=p >,</span> <span class=s2 >"name_right"</span><span class=p >:</span> <span class=s2 >"nearby_city"</span><span class=p >},</span> <span class=n >axis</span><span class=o >=</span><span class=s2 >"columns"</span>
<span class=p >)</span>
<span class=n >joined</span> <span class=o >=</span> <span class=n >joined</span><span class=o >.</span><span class=n >drop</span><span class=p >([</span><span class=s2 >"index_right"</span><span class=p >,</span> <span class=s2 >"buffers"</span><span class=p >],</span> <span class=n >axis</span><span class=o >=</span><span class=s2 >"columns"</span><span class=p >)</span>

<span class=c1 ># Cities are obviously within 500 kilometers of themselves, so</span>
<span class=c1 ># drop the "self joins"</span>
<span class=n >joined</span> <span class=o >=</span> <span class=n >joined</span><span class=p >[</span><span class=o >~</span><span class=p >(</span><span class=n >joined</span><span class=o >.</span><span class=n >city_name</span> <span class=o >==</span> <span class=n >joined</span><span class=o >.</span><span class=n >nearby_city</span><span class=p >)]</span>

<span class=c1 ># Now check out a few!</span>
<span class=n >joined</span><span class=o >.</span><span class=n >sort_values</span><span class=p >(</span><span class=s2 >"city_name"</span><span class=p >)</span>
<br/></pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[13]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>city_name <th>geometry <th>nearby_city <tr> <th>156 <td>Abidjan <td>POINT (-318698.444 829665.928) <td>Accra <tr> <th>156 <td>Abidjan <td>POINT (-318698.444 829665.928) <td>Yamoussoukro <tr> <th>156 <td>Abidjan <td>POINT (-318698.444 829665.928) <td>Lome <tr> <th>38 <td>Abu Dhabi <td>POINT (4286633.823 3707394.154) <td>Doha <tr> <th>38 <td>Abu Dhabi <td>POINT (4286633.823 3707394.154) <td>Manama <tr> <th>... <td>... <td>... <td>... <tr> <th>86 <td>Zagreb <td>POINT (1261548.941 6427274.597) <td>Sarajevo <tr> <th>86 <td>Zagreb <td>POINT (1261548.941 6427274.597) <td>Podgorica <tr> <th>86 <td>Zagreb <td>POINT (1261548.941 6427274.597) <td>Budapest <tr> <th>86 <td>Zagreb <td>POINT (1261548.941 6427274.597) <td>Belgrade <tr> <th>86 <td>Zagreb <td>POINT (1261548.941 6427274.597) <td>Prague </table> <p>410 rows × 3 columns</p> </div></div> </div> <p>And that’s how we can compose operations to do some pretty amazing things!</p> </section> </section> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2021, Nick Eubank. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.5.0. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="../_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>