<!DOCTYPE html> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /><meta name=generator  content="Docutils 0.17.1: http://docutils.sourceforge.net/" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel=stylesheet > <style> body, input { font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif } code, kbd, pre { font-family: "Roboto Mono", "Courier New", Courier, monospace } </style> <link rel=stylesheet  href="../_static/stylesheets/application.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="../_static/fonts/material-icons.css"/> <meta name=theme-color  content="#2196f3"> <script src="../_static/javascripts/modernizr.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XX133829453-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-XX133829453-1'); </script> <title>Renting a VM for Data Science on Azure &#8212; Practical Data Science</title> <link rel=stylesheet  type="text/css" href="../_static/pygments.css" /> <link rel=stylesheet  type="text/css" href="../_static/material.css" /> <script data-url_root="../" id=documentation_options  src="../_static/documentation_options.js"></script> <script src="../_static/jquery.js"></script> <script src="../_static/underscore.js"></script> <script src="../_static/doctools.js"></script> <script crossorigin=anonymous  integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script> <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script> <script defer=defer  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <link rel="shortcut icon" href="../_static/mids_logo.svg"/> <link rel=index  title=Index  href="../genindex.html" /> <link rel=search  title=Search  href="../search.html" /> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=blue> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#999_cloud/cloud_vm_on_azure" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href="../index.html" title="Practical Data Science" class="md-header-nav__button md-logo"> <img src="../_static/mids_logo.svg" height=26  alt="Practical Data Science logo"> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >Practical Data Science</span> <span class=md-header-nav__topic > Renting a VM for Data Science on Azure </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action="../search.html" method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=""Search"" autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <script src="../_static/javascripts/version_dropdown.js"></script> <script> var json_loc = "../"versions.json"", target_loc = "../../", text = "Versions"; $( document ).ready( add_version_dropdown(json_loc, target_loc, text)); </script> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href="../index.html" class=md-tabs__link >Home</a> <li class=md-tabs__item ><a href="../class_schedule.html" class=md-tabs__link >Class Schedule</a> <li class=md-tabs__item ><a href="../topic_list.html" class=md-tabs__link >Topic List</a> <li class=md-tabs__item ><a href="https://www.nickeubank.com" class=md-tabs__link >About The Author</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href="../index.html" title="Practical Data Science" class="md-nav__button md-logo"> <img src="../_static/mids_logo.svg" alt=" logo" width=48  height=48 > </a> <a href="../index.html" title="Practical Data Science">Practical Data Science</a> </label> <ul class=md-nav__list > <li class=md-nav__item > <a href="../class_schedule.html" class=md-nav__link >Class Schedule</a> <li class=md-nav__item > <a href="../autograder_guidelines.html" class=md-nav__link >Autograder Guidelines</a> <li class=md-nav__item > <a href="../not_a_mids_student.html" class=md-nav__link >Not a MIDS Student?</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <label class=md-nav__title  for=__toc >"Contents"</label> <ul class=md-nav__list  data-md-scrollfix=""> <li class=md-nav__item ><a href="#999-cloud-cloud-vm-on-azure--page-root" class=md-nav__link >Renting a VM for Data Science on Azure</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#1.-Create-a-Machine-Learning-Workspace" class=md-nav__link >1. Create a Machine Learning Workspace</a> <li class=md-nav__item ><a href="#2.-Rent-Your-VM" class=md-nav__link >2. Rent Your VM</a> <li class=md-nav__item ><a href="#3.-Connect-Your-Storage" class=md-nav__link >3. Connect Your Storage</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#With-Dask" class=md-nav__link >With Dask</a> <li class=md-nav__item ><a href="#With-Azure-Storage-Library-Library" class=md-nav__link >With Azure Storage Library Library</a> </ul> </nav> <li class=md-nav__item ><a href="#5.-Monitor-Your-Spending" class=md-nav__link >5. Monitor Your Spending</a> <li class=md-nav__item ><a href="#Doing-It-from-the-Command-Line" class=md-nav__link >Doing It from the Command Line</a> <li class=md-nav__item ><a href="#Setting-Up-a-Cluster" class=md-nav__link >Setting Up a Cluster</a> </ul> </nav> </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <style> /* CSS for nbsphinx extension */ /* remove conflicting styling from Sphinx themes */ div.nbinput.container div.prompt *, div.nboutput.container div.prompt *, div.nbinput.container div.input_area pre, div.nboutput.container div.output_area pre, div.nbinput.container div.input_area .highlight, div.nboutput.container div.output_area .highlight { border: none; padding: 0; margin: 0; box-shadow: none; } div.nbinput.container > div[class*=highlight], div.nboutput.container > div[class*=highlight] { margin: 0; } div.nbinput.container div.prompt *, div.nboutput.container div.prompt * { background: none; } div.nboutput.container div.output_area .highlight, div.nboutput.container div.output_area pre { background: unset; } div.nboutput.container div.output_area div.highlight { color: unset; /* override Pygments text color */ } /* avoid gaps between output lines */ div.nboutput.container div[class*=highlight] pre { line-height: normal; } /* input/output containers */ div.nbinput.container, div.nboutput.container { display: -webkit-flex; display: flex; align-items: flex-start; margin: 0; width: 100%; } @media (max-width: 540px) { div.nbinput.container, div.nboutput.container { flex-direction: column; } } /* input container */ div.nbinput.container { padding-top: 5px; } /* last container */ div.nblast.container { padding-bottom: 5px; } /* input prompt */ div.nbinput.container div.prompt pre { color: #307FC1; } /* output prompt */ div.nboutput.container div.prompt pre { color: #BF5B3D; } /* all prompts */ div.nbinput.container div.prompt, div.nboutput.container div.prompt { width: 4.5ex; padding-top: 5px; position: relative; user-select: none; } div.nbinput.container div.prompt > div, div.nboutput.container div.prompt > div { position: absolute; right: 0; margin-right: 0.3ex; } @media (max-width: 540px) { div.nbinput.container div.prompt, div.nboutput.container div.prompt { width: unset; text-align: left; padding: 0.4em; } div.nboutput.container div.prompt.empty { padding: 0; } div.nbinput.container div.prompt > div, div.nboutput.container div.prompt > div { position: unset; } } /* disable scrollbars on prompts */ div.nbinput.container div.prompt pre, div.nboutput.container div.prompt pre { overflow: hidden; } /* input/output area */ div.nbinput.container div.input_area, div.nboutput.container div.output_area { -webkit-flex: 1; flex: 1; overflow: auto; } @media (max-width: 540px) { div.nbinput.container div.input_area, div.nboutput.container div.output_area { width: 100%; } } /* input area */ div.nbinput.container div.input_area { border: 1px solid #e0e0e0; border-radius: 2px; /*background: #f5f5f5;*/ } /* override MathJax center alignment in output cells */ div.nboutput.container div[class*=MathJax] { text-align: left !important; } /* override sphinx.ext.imgmath center alignment in output cells */ div.nboutput.container div.math p { text-align: left; } /* standard error */ div.nboutput.container div.output_area.stderr { background: #fdd; } /* ANSI colors */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-default-inverse-fg { color: #FFFFFF; } .ansi-default-inverse-bg { background-color: #000000; } .ansi-bold { font-weight: bold; } .ansi-underline { text-decoration: underline; } div.nbinput.container div.input_area div[class*=highlight] > pre, div.nboutput.container div.output_area div[class*=highlight] > pre, div.nboutput.container div.output_area div[class*=highlight].math, div.nboutput.container div.output_area.rendered_html, div.nboutput.container div.output_area > div.output_javascript, div.nboutput.container div.output_area:not(.rendered_html) > img{ padding: 5px; margin: 0; } /* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */ div.nbinput.container div.input_area > div[class^='highlight'], div.nboutput.container div.output_area > div[class^='highlight']{ overflow-y: hidden; } /* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */ .prompt .copybtn { display: none; } /* Some additional styling taken form the Jupyter notebook CSS */ .jp-RenderedHTMLCommon table, div.rendered_html table { border: none; border-collapse: collapse; border-spacing: 0; color: black; font-size: 12px; table-layout: fixed; } .jp-RenderedHTMLCommon thead, div.rendered_html thead { border-bottom: 1px solid black; vertical-align: bottom; } .jp-RenderedHTMLCommon tr, .jp-RenderedHTMLCommon th, .jp-RenderedHTMLCommon td, div.rendered_html tr, div.rendered_html th, div.rendered_html td { text-align: right; vertical-align: middle; padding: 0.5em 0.5em; line-height: normal; white-space: normal; max-width: none; border: none; } .jp-RenderedHTMLCommon th, div.rendered_html th { font-weight: bold; } .jp-RenderedHTMLCommon tbody tr:nth-child(odd), div.rendered_html tbody tr:nth-child(odd) { background: #f5f5f5; } .jp-RenderedHTMLCommon tbody tr:hover, div.rendered_html tbody tr:hover { background: rgba(66, 165, 245, 0.2); } </style> <section id=Renting-a-VM-for-Data-Science-on-Azure > <h1 id=999-cloud-cloud-vm-on-azure--page-root >Renting a VM for Data Science on Azure<a class=headerlink  href="#999-cloud-cloud-vm-on-azure--page-root" title="Permalink to this headline">¶</a></h1> <p><em>Most</em> of the time you turn to the cloud for data science, you’ll want to rent a <strong>single (giant) virtual machine</strong> rather than try to setup a cluster. Single virtual machines can have as many 128 cores or 4 V100 GPUs as of late 2020, and hundreds of GB of RAM. Moreover, unlike a cluster, the way you write code to work on a big virtual machines is basically the same as how you’d write code on your personal computer. So while we’ll talk about clusters below (because <em>sometimes</em> you need them), remember: YOUR LIFE WILL ALMOST ALWYS BE EASIER IF YOU JUST GET ONE VIRTUAL MACHINE!</p> <p>There are two ways to do this on Azure:</p> <ul class=simple > <li><p>you can just set-up a basic Virtual Machine, or</p> <li><p>you can use the Azure Machine Learning (AzureML) environment to get a Virtual Machine that’s pre-configured for doing Data Science.</p> </ul> <p>Because as a data scientist you probably just want your VM to work, we’re gonna focus on setting up a <em>pre-configured</em> VM through AzureML. These machines come with R, Python, and Jupyter installed, and you can even open remote RStudio, Jupyter Notebook, or Jupyter Lab sessions with a single click.</p> <section id=1.-Create-a-Machine-Learning-Workspace > <h2 id=1.-Create-a-Machine-Learning-Workspace >1. Create a Machine Learning Workspace<a class=headerlink  href="#1.-Create-a-Machine-Learning-Workspace" title="Permalink to this headline">¶</a></h2> <p>All work within the AzureML ecosystem happens in a <em>Workspace</em>, which you can think of as being like a github repo for your project, able to keep everything associated with a project in one place.</p> <p>So setup a Workspace using the <a class="reference external" href="https://docs.microsoft.com/en-us/azure/machine-learning/how-to-manage-workspace">directions here</a>, with a few added notes from me:</p> <ul class=simple > <li><p>You’re gonna have to name a LOT of things. Like a crazy number. It’s insane how many groups within groups within groups exist in Azure. So for everything I just recommend [your initials][name of thing you’re naming]. I use my Duke ID (<code class="docutils literal notranslate"><span class=pre >nce8</span></code>), so I’ve named my Workspace <code class="docutils literal notranslate"><span class=pre >nce8ws</span></code>. Then when I name a resource group, I’d call it <code class="docutils literal notranslate"><span class=pre >nce8rg</span></code>. Later when you’re comfortable with Azure, you can get fancy, but for now this will keep you sane.</p> <ul> <li><p>Note that some services allow underscores, some allow dashes, and some don’t allow either, so… if you can avoid them, you’ll be able to keep a more consistent naming scheme.</p> </ul> <li><p>At the stage it says “pick a Resource Group if you have one or create a new name”, you don’t have one, so make a new name. See the note above.</p> </ul> <p>Once you create a Workspace, you’ll be brought to a Workspace page. As of October 2020, Microsoft is in the process of migrating from one interface to another, so if you see this in the middle of your landing page:</p> <img alt=azure_new_mlstudio  src="999_cloud/images/azure_new_mlstudio.png"/> <p>Select “Launch Now”, and you should end up on a page whose URL starts with <code class="docutils literal notranslate"><span class=pre >ml.azure.com</span></code>, and which looks like this:</p> <img alt=azure_ml_studio  src="999_cloud/images/azure_ml_studio.png"/> </section> <section id=2.-Rent-Your-VM > <h2 id=2.-Rent-Your-VM >2. Rent Your VM<a class=headerlink  href="#2.-Rent-Your-VM" title="Permalink to this headline">¶</a></h2> <p>A Virtual Machine is an example of a “Compute Resource” – something you’re renting from Azure that actually does computations. Below we’ll talk about renting a cluster of lots of computers, but for now let’s start with a single VM.</p> <p>To setup your VM, go into your ML workspace (URL starts with <code class="docutils literal notranslate"><span class=pre >ml.azure.com</span></code>) and click on <code class="docutils literal notranslate"><span class=pre >Compute</span></code> towards the bottom of the menu on the left.</p> <p>The first option for adding compute is <code class="docutils literal notranslate"><span class=pre >Compute</span> <span class=pre >Instances</span></code> – this is a simple VM. So let’s set one up! Click <code class="docutils literal notranslate"><span class=pre >Create</span></code>, pick <code class="docutils literal notranslate"><span class=pre >CPU</span></code> as your virtual machine type for now (you can also pick a GPU-centric VM if you want!), then check out all the options for <code class="docutils literal notranslate"><span class=pre >Virtual</span> <span class=pre >machine</span> <span class=pre >sizes</span></code>. As you will see, you can get computers with up to 72 individual cores, or up to 256 gb RAM! These are <em>single machines</em> with all these resources! Amazing, right? Note some may be greyed out to prevent you from overspending – you can get those, just takes some extra permissions so Azure is sure you can afford it.</p> <p>The only catch to be aware of is the cost, which is also in that dropdown – if you do rent a single machine with 72 cores, it’ll cost you about 3 dollars an hour. If you just have a day of work you really need, this is a great deal; if you plan to be running simulations for a week… well, that’s pretty darn expensive (though still way less than buying your own dedicated computer!).</p> <p>To try things out, let’s get a basic model – I’m gonna start a <code class="docutils literal notranslate"><span class=pre >Standard_D11_v2</span></code> for 18 cents an hour.</p> <p>Now once you have a VM, you can connect in two ways: you can use JupyterLab, RStudio, or Jupyter; or you can connect via the commandline by enabling SSH (which you will see is an option here). Enabling SSH requires sharing the public key from your personal computer, which takes a little work, so lets skip it for now and just leave that turned off. If/when you want that option, you can find directions for setting up <a class="reference external" href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/mac-create-ssh-keys#provide-an-ssh-public-key-when-deploying-a-vm">SSH keys here</a>. The other ways to connect will become available when the machine is up andr unning. Click <code class="docutils literal notranslate"><span class=pre >Create</span></code>, and go grab a cup of coffee while your machine gets setup! (You’ll have to wait about 5-7 minutes for it to get going).</p> <p>Once it’s running, click on the name of your VM in your list of compute resources, and then click on the <code class="docutils literal notranslate"><span class=pre >Run</span></code> tab. There, on the right side, you’ll see a series of links to Jupyter, JupyterLab, RSTudio, and (if you enabled it) ssh:</p> <img alt=azure_vm_services  src="999_cloud/images/azure_vm_services.png"/> <p>Just click on those links and the service you requested for the VM will pop up! TA-DA! You’re running Jupyter on the cloud!</p> <p>(Because we’re in AzureML, the VMs offered are all running the linux operating system and come with standard Data Science software installed. If you want a different kind of VM – say, a Windows machine, or a linux machine without software pre-installed – go back to your <a class="reference external" href="https://portal.azure.com/#home">Azure Portal page</a>, and select “Virtual Machines.” There you can completely control the configuration of your VM, and even set up a Remote Desktop Connection if you want to use a regular Windows experience with full graphical user interface.)</p> <p><strong>Now when you’re done playing with this VM, SHUT IT DOWN! As long as it’s running, you’re paying for it (it takes a way for the bill to show up in your expenditures). The clusters we’ll use later are able to turn themselves off if they’re idle, but for this dedicated VM, you have to turn it off yourself.</strong></p> <p>If you want to go the VM route, you may also be interested in how you can mount your Cloud storage just like another volume on your computer instead of accessing it through fancy Python libraries. If so, be sure to check out the later lesson on <a class="reference external" href=cloud_azurestorage.ipynb >Azure Storage configurations</a></p> </section> <section id=3.-Connect-Your-Storage > <h2 id=3.-Connect-Your-Storage >3. Connect Your Storage<a class=headerlink  href="#3.-Connect-Your-Storage" title="Permalink to this headline">¶</a></h2> <p>Congratulations – you’re almost there! You have a computer that should feel extremely familiar but is SUPER powerful, and if you did the <a class="reference internal" href=cloud_storage_on_azure.html ><span class=doc >previous exercise</span></a>, you have a place to get and put data! The only thing left to do is figure out how to move data back and forth from storage.</p> <p>There are basically two ways to do this: you can do it through <code class="docutils literal notranslate"><span class=pre >dask</span></code> (recommended if you plan to use <code class="docutils literal notranslate"><span class=pre >dask</span></code> anyway), or in a more direct way with <code class="docutils literal notranslate"><span class=pre >azure-storage-blob</span></code>.</p> <section id=With-Dask > <h3 id=With-Dask >With Dask<a class=headerlink  href="#With-Dask" title="Permalink to this headline">¶</a></h3> <p>To access tabular data on Azure storage with <code class="docutils literal notranslate"><span class=pre >dask</span></code>, start by running:</p> <ul class=simple > <li><p><code class="docutils literal notranslate"><span class=pre >pip</span> <span class=pre >install</span> <span class=pre >"dask_cloudprovider[all]==0.4.1"</span></code></p> <li><p><code class="docutils literal notranslate"><span class=pre >pip</span> <span class=pre >install</span> <span class=pre >adlfs</span></code></p> <li><p><code class="docutils literal notranslate"><span class=pre >pip</span> <span class=pre >install</span> <span class=pre >distributed</span> <span class=pre >--upgrade</span></code></p> </ul> <p>Then you just need your Storage Account name and Access Key, which you can get by going to your Azure Portal, then your Storage Account, and then clicking on “Access Keys” on the left menu.</p> <p><strong>NOTE YOUR STORAGE ACCOUNT NAME AND KEY GIVES ANYONE ACCESS TO YOUR STORAGE</strong> so don’t put the string directly in your code and then commit it to github!!! Instead, save it to a plaintext file somewhere and then in your code read that string, like I do below.</p> <p>The syntax is:</p> <div class="highlight-none notranslate"><div class=highlight ><pre><span></span>import dask.dataframe as dd

storage_options={'account_name': ACCOUNT_NAME, 'account_key': ACCOUNT_KEY}

ddf = dd.read_csv('az://{CONTAINER}/{FOLDER}/*.csv', storage_options=storage_options)
ddf = dd.read_parquet('az://{CONTAINER}/folder.parquet', storage_options=storage_options)
</pre></div> </div> <p>But since I don’t want you to see all my secret codes, I’m gonna load my information from a file. You can do this, but you can also put them in your code <em>if your code isn’t public!</em></p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[1]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=o >%</span><span class=k >load_ext</span> nb_black

<span class=c1 ># Dask connects with a protocl</span>
<span class=kn >import</span> <span class=nn >json</span>

<span class=k >with</span> <span class=nb >open</span><span class=p >(</span><span class=s2 >"/users/nick/azure_secrets/azure_sa_name_and_key.json"</span><span class=p >)</span> <span class=k >as</span> <span class=n >f</span><span class=p >:</span>
    <span class=n >storage_options</span> <span class=o >=</span> <span class=n >json</span><span class=o >.</span><span class=n >load</span><span class=p >(</span><span class=n >f</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=output_javascript ></div> <script> var element = document.currentScript.previousSibling.previousSibling; setTimeout(function() { var nbb_cell_id = 1; var nbb_unformatted_code = "%load_ext nb_black\n\n# Dask connects with a protocl\nimport json\n\nwith open(\"/users/nick/azure_secrets/azure_sa_name_and_key.json\") as f:\n storage_options = json.load(f)"; var nbb_formatted_code = "%load_ext nb_black\n\n# Dask connects with a protocl\nimport json\n\nwith open(\"/users/nick/azure_secrets/azure_sa_name_and_key.json\") as f:\n storage_options = json.load(f)"; var nbb_cells = Jupyter.notebook.get_cells(); for (var i = 0; i < nbb_cells.length; ++i) { if (nbb_cells[i].input_prompt_number == nbb_cell_id) { if (nbb_cells[i].get_text() == nbb_unformatted_code) { nbb_cells[i].set_text(nbb_formatted_code); } break; } } }, 500); </script></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[2]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >dask.dataframe</span> <span class=k >as</span> <span class=nn >dd</span>

<span class=n >temps</span> <span class=o >=</span> <span class=n >dd</span><span class=o >.</span><span class=n >read_csv</span><span class=p >(</span>
    <span class=s2 >"az://globaltemps/ghcnd_daily.csv"</span><span class=p >,</span>
    <span class=n >storage_options</span><span class=o >=</span><span class=n >storage_options</span><span class=p >,</span>
    <span class=n >usecols</span><span class=o >=</span><span class=p >[</span><span class=s1 >'id'</span><span class=p >,</span> <span class=s1 >'year'</span><span class=p >,</span> <span class=s1 >'month'</span><span class=p >,</span> <span class=s1 >'element'</span><span class=p >,</span> <span class=s1 >'value1'</span><span class=p >]</span>
<span class=p >)</span><span class=o >.</span><span class=n >head</span><span class=p >(</span><span class=mi >100</span><span class=p >)</span>
<span class=n >temps</span><span class=o >.</span><span class=n >head</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[2]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>id <th>year <th>month <th>element <th>value1 <tr> <th>0 <td>ACW00011604 <td>1949 <td>1 <td>TMAX <td>289 <tr> <th>1 <td>ACW00011604 <td>1949 <td>2 <td>TMAX <td>267 <tr> <th>2 <td>ACW00011604 <td>1949 <td>3 <td>TMAX <td>272 <tr> <th>3 <td>ACW00011604 <td>1949 <td>4 <td>TMAX <td>278 <tr> <th>4 <td>ACW00011604 <td>1949 <td>5 <td>TMAX <td>283 </table> </div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=output_javascript ></div> <script> var element = document.currentScript.previousSibling.previousSibling; setTimeout(function() { var nbb_cell_id = 2; var nbb_unformatted_code = "import dask.dataframe as dd\n\ntemps = dd.read_csv(\n \"az://globaltemps/ghcnd_daily.csv\",\n storage_options=storage_options,\n usecols=['id', 'year', 'month', 'element', 'value1']\n).head(100)\ntemps.head()"; var nbb_formatted_code = "import dask.dataframe as dd\n\ntemps = dd.read_csv(\n \"az://globaltemps/ghcnd_daily.csv\",\n storage_options=storage_options,\n usecols=[\"id\", \"year\", \"month\", \"element\", \"value1\"],\n).head(100)\ntemps.head()"; var nbb_cells = Jupyter.notebook.get_cells(); for (var i = 0; i < nbb_cells.length; ++i) { if (nbb_cells[i].input_prompt_number == nbb_cell_id) { if (nbb_cells[i].get_text() == nbb_unformatted_code) { nbb_cells[i].set_text(nbb_formatted_code); } break; } } }, 500); </script></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[3]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Now save to new blob. Note need to move back into a Dask dataframe first.</span>
<span class=n >dask_temps</span> <span class=o >=</span> <span class=n >dd</span><span class=o >.</span><span class=n >from_pandas</span><span class=p >(</span><span class=n >temps</span><span class=p >,</span> <span class=n >npartitions</span><span class=o >=</span><span class=mi >1</span><span class=p >,)</span>
<span class=n >dask_temps</span><span class=o >.</span><span class=n >to_csv</span><span class=p >(</span><span class=s2 >"az://globaltemps/top_few_lines_of_temps.csv"</span><span class=p >,</span>
             <span class=n >storage_options</span><span class=o >=</span><span class=n >storage_options</span><span class=p >,</span>
                 <span class=n >single_file</span><span class=o >=</span><span class=kc >True</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area stderr docutils container"> <div class=highlight ><pre>
/Users/Nick/miniconda3/lib/python3.7/site-packages/dask/dataframe/io/csv.py:807: UserWarning: Appending data to a network storage system may not work.
  warn("Appending data to a network storage system may not work.")
</pre></div></div> </div> <div class="nboutput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[3]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
['globaltemps/top_few_lines_of_temps.csv']
</pre></div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=output_javascript ></div> <script> var element = document.currentScript.previousSibling.previousSibling; setTimeout(function() { var nbb_cell_id = 3; var nbb_unformatted_code = "# Now save to new blob. Note need to move back into a Dask dataframe first. \ndask_temps = dd.from_pandas(temps, npartitions=1,)\ndask_temps.to_csv(\"az://globaltemps/top_few_lines_of_temps.csv\",\n storage_options=storage_options,\n single_file=True)"; var nbb_formatted_code = "# Now save to new blob. Note need to move back into a Dask dataframe first.\ndask_temps = dd.from_pandas(\n temps,\n npartitions=1,\n)\ndask_temps.to_csv(\n \"az://globaltemps/top_few_lines_of_temps.csv\",\n storage_options=storage_options,\n single_file=True,\n)"; var nbb_cells = Jupyter.notebook.get_cells(); for (var i = 0; i < nbb_cells.length; ++i) { if (nbb_cells[i].input_prompt_number == nbb_cell_id) { if (nbb_cells[i].get_text() == nbb_unformatted_code) { nbb_cells[i].set_text(nbb_formatted_code); } break; } } }, 500); </script></div> </div> </section> <section id=With-Azure-Storage-Library-Library > <h3 id=With-Azure-Storage-Library-Library >With Azure Storage Library Library<a class=headerlink  href="#With-Azure-Storage-Library-Library" title="Permalink to this headline">¶</a></h3> <p>Azure publishes a storage-management library that, in addition to reading and writing data, can also create new blobs, new containers, list contents, etc. So it’s a little uglier, but more flexible. You can read all about <a class="reference external" href="https://docs.microsoft.com/en-us/azure/storage/blobs/storage-quickstart-blobs-python">it here</a>, but below we’ll just read a table into pandas. Note it uses the “Connection String” rather than your Storage Account name and Key (it’s just a concatenation of the two).</p> <p>In general I’d use dask for any tabular data as it can chunk streams from Azure easily, but if you have other data on Azure (e.g. a binary file, images, etc.), the code flow below results in the Azure file being treated like a file on disk.</p> <ol class="arabic simple"> <li><p>Running <code class="docutils literal notranslate"><span class=pre >pip</span> <span class=pre >install</span> <span class=pre >azure-storage-blob</span></code>.</p> <li><p>Navigate to the Storage Account where you put data in your last exercise in your browser. On the left hand menu, under <code class="docutils literal notranslate"><span class=pre >Settings</span></code>, select <code class="docutils literal notranslate"><span class=pre >Access</span> <span class=pre >Keys</span></code> and copy the first <code class="docutils literal notranslate"><span class=pre >Connection</span> <span class=pre >String</span></code>. This is the secret code for accessing your storage.</p> <ul class=simple > <li><p>Again, <strong>THIS GIVES ANYONE WITH THE STRING ACCESS TO YOUR STORAGE</strong> so don’t put the string directly in your code and then commit it to github!!! Instead, save it to a plaintext file somewhere and then in your code read that string, like I do below.</p> </ul> <li><p>Then in Python, just import the BlobClient and you can read your data!</p> </ol> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[4]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >from</span> <span class=nn >azure.storage.blob</span> <span class=kn >import</span> <span class=n >BlobClient</span>
<span class=kn >import</span> <span class=nn >pandas</span> <span class=k >as</span> <span class=nn >pd</span>

<span class=c1 ># Load connection string so y'all can't see it!</span>
<span class=k >with</span> <span class=nb >open</span><span class=p >(</span><span class=s2 >"/users/nick/azure_secrets/azure_sa_connection_string.txt"</span><span class=p >)</span> <span class=k >as</span> <span class=n >f</span><span class=p >:</span>
    <span class=n >connection_string</span> <span class=o >=</span> <span class=n >f</span><span class=o >.</span><span class=n >read</span><span class=p >()</span>

<span class=c1 ># Connect to storage account</span>
<span class=n >b</span> <span class=o >=</span> <span class=n >BlobClient</span><span class=o >.</span><span class=n >from_connection_string</span><span class=p >(</span><span class=n >connection_string</span><span class=p >,</span>
                                      <span class=n >container_name</span><span class=o >=</span><span class=s2 >"globaltemps"</span><span class=p >,</span>
                                      <span class=n >blob_name</span><span class=o >=</span><span class=s2 >"ghcnd_daily.csv"</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=output_javascript ></div> <script> var element = document.currentScript.previousSibling.previousSibling; setTimeout(function() { var nbb_cell_id = 4; var nbb_unformatted_code = "from azure.storage.blob import BlobClient\nimport pandas as pd\n\n# Load connection string so y'all can't see it!\nwith open(\"/users/nick/azure_secrets/azure_sa_connection_string.txt\") as f:\n connection_string = f.read()\n\n# Connect to storage account\nb = BlobClient.from_connection_string(connection_string, \n container_name=\"globaltemps\", \n blob_name=\"ghcnd_daily.csv\")"; var nbb_formatted_code = "from azure.storage.blob import BlobClient\nimport pandas as pd\n\n# Load connection string so y'all can't see it!\nwith open(\"/users/nick/azure_secrets/azure_sa_connection_string.txt\") as f:\n connection_string = f.read()\n\n# Connect to storage account\nb = BlobClient.from_connection_string(\n connection_string, container_name=\"globaltemps\", blob_name=\"ghcnd_daily.csv\"\n)"; var nbb_cells = Jupyter.notebook.get_cells(); for (var i = 0; i < nbb_cells.length; ++i) { if (nbb_cells[i].input_prompt_number == nbb_cell_id) { if (nbb_cells[i].get_text() == nbb_unformatted_code) { nbb_cells[i].set_text(nbb_formatted_code); } break; } } }, 500); </script></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[5]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >from</span> <span class=nn >io</span> <span class=kn >import</span> <span class=n >StringIO</span>
<span class=n >stream</span> <span class=o >=</span> <span class=n >b</span><span class=o >.</span><span class=n >download_blob</span><span class=p >()</span><span class=o >.</span><span class=n >content_as_text</span><span class=p >()</span>
<span class=n >df</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >read_csv</span><span class=p >(</span><span class=n >StringIO</span><span class=p >(</span><span class=n >stream</span><span class=p >),</span>
                 <span class=n >usecols</span><span class=o >=</span><span class=p >[</span><span class=s1 >'id'</span><span class=p >,</span> <span class=s1 >'year'</span><span class=p >,</span> <span class=s1 >'month'</span><span class=p >,</span> <span class=s1 >'element'</span><span class=p >,</span> <span class=s1 >'value1'</span><span class=p >],</span> <span class=n >nrows</span><span class=o >=</span><span class=mi >100</span>
<span class=p >)</span>
<span class=n >df</span><span class=o >.</span><span class=n >head</span><span class=p >()</span>
</pre></div> </div> </div> <div class="nboutput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[5]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>id <th>year <th>month <th>element <th>value1 <tr> <th>0 <td>ACW00011604 <td>1949 <td>1 <td>TMAX <td>289 <tr> <th>1 <td>ACW00011604 <td>1949 <td>2 <td>TMAX <td>267 <tr> <th>2 <td>ACW00011604 <td>1949 <td>3 <td>TMAX <td>272 <tr> <th>3 <td>ACW00011604 <td>1949 <td>4 <td>TMAX <td>278 <tr> <th>4 <td>ACW00011604 <td>1949 <td>5 <td>TMAX <td>283 </table> </div></div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=output_javascript ></div> <script> var element = document.currentScript.previousSibling.previousSibling; setTimeout(function() { var nbb_cell_id = 5; var nbb_unformatted_code = "from io import StringIO\nstream = b.download_blob().content_as_text()\ndf = pd.read_csv(StringIO(stream), \n usecols=['id', 'year', 'month', 'element', 'value1'], nrows=100\n)\ndf.head()"; var nbb_formatted_code = "from io import StringIO\n\nstream = b.download_blob().content_as_text()\ndf = pd.read_csv(\n StringIO(stream), usecols=[\"id\", \"year\", \"month\", \"element\", \"value1\"], nrows=100\n)\ndf.head()"; var nbb_cells = Jupyter.notebook.get_cells(); for (var i = 0; i < nbb_cells.length; ++i) { if (nbb_cells[i].input_prompt_number == nbb_cell_id) { if (nbb_cells[i].get_text() == nbb_unformatted_code) { nbb_cells[i].set_text(nbb_formatted_code); } break; } } }, 500); </script></div> </div> </section> </section> <section id=5.-Monitor-Your-Spending > <h2 id=5.-Monitor-Your-Spending >5. Monitor Your Spending<a class=headerlink  href="#5.-Monitor-Your-Spending" title="Permalink to this headline">¶</a></h2> <p><em>Note: As of October 2020, this service is in preview for paid accounts, but likely won’t work if you’re just using a free demo account, sorry! I’m leaving it here for reference, however, since should be everywhere soon!</em></p> <p>One last little safeguard: Azure doesn’t let you set spending caps, but you can set up alerts. To do so, go back to Azure Portal and select the Subscriptions (search in the top bar if the key icon isn’t already up). Click on it, then click “Cost alerts” on the left hand side.</p> <p>Then click <code class="docutils literal notranslate"><span class=pre >+</span> <span class=pre >Add</span></code>, set a budget and hit <code class="docutils literal notranslate"><span class=pre >Next</span></code>. Then put in your email first (or it gets grumpy), then set some alerts for, say, 25%, 50%, 75% and 100% of your budget. Trust me – we’ll try hard to only set things up so that if you forget about them they’ll shut themselves down, but the worst thing in the world is forgetting you left a VM running and coming back a week later to find a bill of hundreds of dollars! So add these alerts!</p> <p>Note you can also set alerts <em>by Resource Group</em>, but if you do, there’s always a risk you’ll create a new Resource Group at some point and forget to add alerts, then do something silly, so I just tag them to my subscription so it covers everything.</p> </section> <section id=Doing-It-from-the-Command-Line > <h2 id=Doing-It-from-the-Command-Line >Doing It from the Command Line<a class=headerlink  href="#Doing-It-from-the-Command-Line" title="Permalink to this headline">¶</a></h2> <p>One last note: if you find all this pointing and clicking tedious, there are tools to manage all this kind of stuff from the command line, but because you need to know what you’re looking for to know what commands to use, I think seeing the Azure websites with all their menus is a better way to start off. But if you do want to get into command line tools, you can read about the <a class="reference external" href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli">Azure Command Line Interface (CLI)</a> here, and as we’ll see later, there are also lots of Python libraries that can do the same from within a Python session.</p> </section> <section id=Setting-Up-a-Cluster > <h2 id=Setting-Up-a-Cluster >Setting Up a Cluster<a class=headerlink  href="#Setting-Up-a-Cluster" title="Permalink to this headline">¶</a></h2> <p>OK, so… you’re <em>sure</em> a single giant VM isn’t enough for you? OK then! <a class="reference internal" href=cloud_cluster_on_azure.html ><span class=doc >On to clusters…</span></a>.</p> </section> </section> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2021, Nick Eubank. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.5.0. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="../_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>