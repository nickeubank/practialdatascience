<!DOCTYPE html> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /><meta name=generator  content="Docutils 0.17.1: http://docutils.sourceforge.net/" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel=stylesheet > <style> body, input { font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif } code, kbd, pre { font-family: "Roboto Mono", "Courier New", Courier, monospace } </style> <link rel=stylesheet  href="../_static/stylesheets/application.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="../_static/fonts/material-icons.css"/> <meta name=theme-color  content="#2196f3"> <script src="../_static/javascripts/modernizr.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XX133829453-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-XX133829453-1'); </script> <title>The View/Copy Headache in pandas without Copy on Write &#8212; Practical Data Science</title> <link rel=stylesheet  type="text/css" href="../_static/pygments.css" /> <link rel=stylesheet  type="text/css" href="../_static/material.css" /> <script data-url_root="../" id=documentation_options  src="../_static/documentation_options.js"></script> <script src="../_static/jquery.js"></script> <script src="../_static/underscore.js"></script> <script src="../_static/doctools.js"></script> <script crossorigin=anonymous  integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script> <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script> <script defer=defer  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <link rel="shortcut icon" href="../_static/mids_logo.svg"/> <link rel=index  title=Index  href="../genindex.html" /> <link rel=search  title=Search  href="../search.html" /> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=blue> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#40_pandas_basics/50_views_and_copies_in_pandas_wo_CoW" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href="../index.html" title="Practical Data Science" class="md-header-nav__button md-logo"> <img src="../_static/mids_logo.svg" height=26  alt="Practical Data Science logo"> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >Practical Data Science</span> <span class=md-header-nav__topic > The View/Copy Headache in pandas without Copy on Write </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action="../search.html" method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=""Search"" autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <script src="../_static/javascripts/version_dropdown.js"></script> <script> var json_loc = "../"versions.json"", target_loc = "../../", text = "Versions"; $( document ).ready( add_version_dropdown(json_loc, target_loc, text)); </script> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href="../index.html" class=md-tabs__link >Home</a> <li class=md-tabs__item ><a href="../class_schedule.html" class=md-tabs__link >Class Schedule</a> <li class=md-tabs__item ><a href="../topic_list.html" class=md-tabs__link >Topic List</a> <li class=md-tabs__item ><a href="https://www.nickeubank.com" class=md-tabs__link >About The Author</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href="../index.html" title="Practical Data Science" class="md-nav__button md-logo"> <img src="../_static/mids_logo.svg" alt=" logo" width=48  height=48 > </a> <a href="../index.html" title="Practical Data Science">Practical Data Science</a> </label> <ul class=md-nav__list > <li class=md-nav__item > <a href="../class_schedule.html" class=md-nav__link >Class Schedule</a> <li class=md-nav__item > <a href="../autograder_guidelines.html" class=md-nav__link >Autograder Guidelines</a> <li class=md-nav__item > <a href="../not_a_mids_student.html" class=md-nav__link >Not a MIDS Student?</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <label class=md-nav__title  for=__toc >"Contents"</label> <ul class=md-nav__list  data-md-scrollfix=""> <li class=md-nav__item ><a href="#40-pandas-basics-50-views-and-copies-in-pandas-wo-cow--page-root" class=md-nav__link >The View/Copy Headache in pandas without Copy on Write</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#The-Problem:-A-Demonstration" class=md-nav__link >The Problem: A Demonstration</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Dealing-with-Views-If-You-Don’t-Want-To-Use-CoW" class=md-nav__link >Dealing with Views If You Don’t Want To Use CoW</a> <li class=md-nav__item ><a href="#An-Aside:-No,-the-problem-doesn’t-only-emerge-when-you-change-the-data-type-of-a-column" class=md-nav__link >An Aside: No, the problem doesn’t <em>only</em> emerge when you change the data type of a column</a> </ul> </nav> </ul> </nav> </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <style> /* CSS for nbsphinx extension */ /* remove conflicting styling from Sphinx themes */ div.nbinput.container div.prompt *, div.nboutput.container div.prompt *, div.nbinput.container div.input_area pre, div.nboutput.container div.output_area pre, div.nbinput.container div.input_area .highlight, div.nboutput.container div.output_area .highlight { border: none; padding: 0; margin: 0; box-shadow: none; } div.nbinput.container > div[class*=highlight], div.nboutput.container > div[class*=highlight] { margin: 0; } div.nbinput.container div.prompt *, div.nboutput.container div.prompt * { background: none; } div.nboutput.container div.output_area .highlight, div.nboutput.container div.output_area pre { background: unset; } div.nboutput.container div.output_area div.highlight { color: unset; /* override Pygments text color */ } /* avoid gaps between output lines */ div.nboutput.container div[class*=highlight] pre { line-height: normal; } /* input/output containers */ div.nbinput.container, div.nboutput.container { display: -webkit-flex; display: flex; align-items: flex-start; margin: 0; width: 100%; } @media (max-width: 540px) { div.nbinput.container, div.nboutput.container { flex-direction: column; } } /* input container */ div.nbinput.container { padding-top: 5px; } /* last container */ div.nblast.container { padding-bottom: 5px; } /* input prompt */ div.nbinput.container div.prompt pre { color: #307FC1; } /* output prompt */ div.nboutput.container div.prompt pre { color: #BF5B3D; } /* all prompts */ div.nbinput.container div.prompt, div.nboutput.container div.prompt { width: 4.5ex; padding-top: 5px; position: relative; user-select: none; } div.nbinput.container div.prompt > div, div.nboutput.container div.prompt > div { position: absolute; right: 0; margin-right: 0.3ex; } @media (max-width: 540px) { div.nbinput.container div.prompt, div.nboutput.container div.prompt { width: unset; text-align: left; padding: 0.4em; } div.nboutput.container div.prompt.empty { padding: 0; } div.nbinput.container div.prompt > div, div.nboutput.container div.prompt > div { position: unset; } } /* disable scrollbars on prompts */ div.nbinput.container div.prompt pre, div.nboutput.container div.prompt pre { overflow: hidden; } /* input/output area */ div.nbinput.container div.input_area, div.nboutput.container div.output_area { -webkit-flex: 1; flex: 1; overflow: auto; } @media (max-width: 540px) { div.nbinput.container div.input_area, div.nboutput.container div.output_area { width: 100%; } } /* input area */ div.nbinput.container div.input_area { border: 1px solid #e0e0e0; border-radius: 2px; /*background: #f5f5f5;*/ } /* override MathJax center alignment in output cells */ div.nboutput.container div[class*=MathJax] { text-align: left !important; } /* override sphinx.ext.imgmath center alignment in output cells */ div.nboutput.container div.math p { text-align: left; } /* standard error */ div.nboutput.container div.output_area.stderr { background: #fdd; } /* ANSI colors */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-default-inverse-fg { color: #FFFFFF; } .ansi-default-inverse-bg { background-color: #000000; } .ansi-bold { font-weight: bold; } .ansi-underline { text-decoration: underline; } div.nbinput.container div.input_area div[class*=highlight] > pre, div.nboutput.container div.output_area div[class*=highlight] > pre, div.nboutput.container div.output_area div[class*=highlight].math, div.nboutput.container div.output_area.rendered_html, div.nboutput.container div.output_area > div.output_javascript, div.nboutput.container div.output_area:not(.rendered_html) > img{ padding: 5px; margin: 0; } /* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */ div.nbinput.container div.input_area > div[class^='highlight'], div.nboutput.container div.output_area > div[class^='highlight']{ overflow-y: hidden; } /* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */ .prompt .copybtn { display: none; } /* Some additional styling taken form the Jupyter notebook CSS */ .jp-RenderedHTMLCommon table, div.rendered_html table { border: none; border-collapse: collapse; border-spacing: 0; color: black; font-size: 12px; table-layout: fixed; } .jp-RenderedHTMLCommon thead, div.rendered_html thead { border-bottom: 1px solid black; vertical-align: bottom; } .jp-RenderedHTMLCommon tr, .jp-RenderedHTMLCommon th, .jp-RenderedHTMLCommon td, div.rendered_html tr, div.rendered_html th, div.rendered_html td { text-align: right; vertical-align: middle; padding: 0.5em 0.5em; line-height: normal; white-space: normal; max-width: none; border: none; } .jp-RenderedHTMLCommon th, div.rendered_html th { font-weight: bold; } .jp-RenderedHTMLCommon tbody tr:nth-child(odd), div.rendered_html tbody tr:nth-child(odd) { background: #f5f5f5; } .jp-RenderedHTMLCommon tbody tr:hover, div.rendered_html tbody tr:hover { background: rgba(66, 165, 245, 0.2); } </style> <section id="The-View/Copy-Headache-in-pandas-without-Copy-on-Write"> <h1 id=40-pandas-basics-50-views-and-copies-in-pandas-wo-cow--page-root >The View/Copy Headache in pandas without Copy on Write<a class=headerlink  href="#40-pandas-basics-50-views-and-copies-in-pandas-wo-cow--page-root" title="Permalink to this headline">¶</a></h1> <p>After the last reading, you may be saying “ugh, but I don’t want to write <code class="docutils literal notranslate"><span class=pre >pd.set_option("mode.copy_on_write",</span> <span class=pre >True)</span></code> at the top of all my files!” I hear you. I don’t either. But allow me to explain what happens <em>without</em> Copy on Write (CoW) enabled:</p> <blockquote> <div><p>Without Copy on Write, whether you get a view or a copy in pandas—and whether changes made to a view will propagate back to the original <code class="docutils literal notranslate"><span class=pre >DataFrame</span></code>—depends not only on the operations you execute (<code class="docutils literal notranslate"><span class=pre >.loc</span></code>, <code class="docutils literal notranslate"><span class=pre >.iloc</span></code>, etc.), but also on the structure of the data in the original DataFrame in ways that are, essentially, impossible to predict consistently.</p> </div></blockquote> <p>Allow me to demonstrate.</p> <section id="The-Problem:-A-Demonstration"> <h2 id="The-Problem:-A-Demonstration">The Problem: A Demonstration<a class=headerlink  href="#The-Problem:-A-Demonstration" title="Permalink to this headline">¶</a></h2> <p>To illustrate how weird views and copies can be in pandas without CoW, let’s look at two examples of <em>basically</em> identical manipulations that result in very different behavior.</p> <p>First, here is some code that takes a subset of a DataFrame and then modifies the data in the DataFrame. As we will see, this results in a change in the slice:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[1]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >pandas</span> <span class=k >as</span> <span class=nn >pd</span>

<span class=c1 ># This is the default option so I don't strictly</span>
<span class=c1 ># need this command, but I'll add it to be explicit</span>
<span class=n >pd</span><span class=o >.</span><span class=n >set_option</span><span class=p >(</span><span class=s2 >"mode.copy_on_write"</span><span class=p >,</span> <span class=kc >False</span><span class=p >)</span>

<span class=n >df</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >DataFrame</span><span class=p >({</span><span class=s2 >"a"</span><span class=p >:</span> <span class=p >[</span><span class=mi >10</span><span class=p >,</span> <span class=mi >20</span><span class=p >,</span> <span class=mi >30</span><span class=p >,</span> <span class=mi >40</span><span class=p >],</span> <span class=s2 >"b"</span><span class=p >:</span> <span class=p >[</span><span class=mi >11</span><span class=p >,</span> <span class=mi >12</span><span class=p >,</span> <span class=mi >13</span><span class=p >,</span> <span class=mi >14</span><span class=p >]})</span>
<span class=n >df</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[1]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>0 <td>10 <td>11 <tr> <th>1 <td>20 <td>12 <tr> <th>2 <td>30 <td>13 <tr> <th>3 <td>40 <td>14 </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[2]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >my_slice</span> <span class=o >=</span> <span class=n >df</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >1</span><span class=p >:</span><span class=mi >3</span><span class=p >,]</span>
<span class=n >my_slice</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[2]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>1 <td>20 <td>12 <tr> <th>2 <td>30 <td>13 </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[3]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >df</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >1</span><span class=p >,</span> <span class=mi >1</span><span class=p >]</span> <span class=o >=</span> <span class=o >-</span><span class=mi >1</span>
<span class=n >df</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[3]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>0 <td>10 <td>11 <tr> <th>1 <td>20 <td>-1 <tr> <th>2 <td>30 <td>13 <tr> <th>3 <td>40 <td>14 </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[4]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >my_slice</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[4]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>1 <td>20 <td>-1 <tr> <th>2 <td>30 <td>13 </table> </div></div> </div> <p>Voilà, the change to the DataFrame has propagated to the slice, so clearly, the slice was a view, right? Well… kinda.</p> <p>Now observe what happens if we do the same operation, but now instead of changing the entry at <code class="docutils literal notranslate"><span class=pre >df.iloc[1,</span> <span class=pre >1]</span></code> to <code class="docutils literal notranslate"><span class=pre >-1</span></code>, we change it to <code class="docutils literal notranslate"><span class=pre >3.14</span></code>. You would <em>assume</em> the behavior of pandas would be unchanged, but…:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[5]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Same DataFrame and subset:</span>
<span class=n >df</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >DataFrame</span><span class=p >({</span><span class=s2 >"a"</span><span class=p >:</span> <span class=p >[</span><span class=mi >10</span><span class=p >,</span> <span class=mi >20</span><span class=p >,</span> <span class=mi >30</span><span class=p >,</span> <span class=mi >40</span><span class=p >],</span> <span class=s2 >"b"</span><span class=p >:</span> <span class=p >[</span><span class=mi >11</span><span class=p >,</span> <span class=mi >12</span><span class=p >,</span> <span class=mi >13</span><span class=p >,</span> <span class=mi >14</span><span class=p >]})</span>
<span class=n >my_slice</span> <span class=o >=</span> <span class=n >df</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >1</span><span class=p >:</span><span class=mi >3</span><span class=p >,]</span>
<span class=n >my_slice</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[5]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>1 <td>20 <td>12 <tr> <th>2 <td>30 <td>13 </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[6]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># But now we set the value to 3.14 instead of -1.</span>
<span class=n >df</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >1</span><span class=p >,</span> <span class=mi >1</span><span class=p >]</span> <span class=o >=</span> <span class=mf >3.14</span>
<span class=n >df</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[6]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>0 <td>10 <td>11.00 <tr> <th>1 <td>20 <td>3.14 <tr> <th>2 <td>30 <td>13.00 <tr> <th>3 <td>40 <td>14.00 </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[7]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># And as you can see, in this instance</span>
<span class=c1 ># the data in `my_slice` is unchanged.</span>
<span class=n >my_slice</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[7]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>1 <td>20 <td>12 <tr> <th>2 <td>30 <td>13 </table> </div></div> </div> <p>(Why this happens isn’t actually important to understand, but for those who are interested: in the first modification, I replaced one integer with another, so that operation could be done in the existing integer array; in the second, I try to put a floating point number into an integer array. This can’t be done, so a new floating point array was created, and that new array replaced the old one as column <code class="docutils literal notranslate"><span class=pre >a</span></code> in the original DataFrame, breaking the “view” connection.)</p> <p>Note that this behavior applies not just to row slices, but also column slices:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[8]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >df</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[8]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>0 <td>10 <td>11.00 <tr> <th>1 <td>20 <td>3.14 <tr> <th>2 <td>30 <td>13.00 <tr> <th>3 <td>40 <td>14.00 </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[9]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># This initial change propagates</span>
<span class=n >column_a</span> <span class=o >=</span> <span class=n >df</span><span class=p >[</span><span class=s2 >"a"</span><span class=p >]</span>
<span class=n >df</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >0</span><span class=p >,</span> <span class=mi >0</span><span class=p >]</span> <span class=o >=</span> <span class=o >-</span><span class=mi >42</span>
<span class=n >column_a</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[9]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
0   -42
1    20
2    30
3    40
Name: a, dtype: int64
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[10]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># But this does not</span>
<span class=n >df</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >0</span><span class=p >,</span> <span class=mi >0</span><span class=p >]</span> <span class=o >=</span> <span class=s2 >"a"</span>
<span class=n >df</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[10]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>0 <td>a <td>11.00 <tr> <th>1 <td>20 <td>3.14 <tr> <th>2 <td>30 <td>13.00 <tr> <th>3 <td>40 <td>14.00 </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[11]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >column_a</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[11]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
0   -42
1    20
2    30
3    40
Name: a, dtype: int64
</pre></div></div> </div> <section id="Dealing-with-Views-If-You-Don’t-Want-To-Use-CoW"> <h3 id="Dealing-with-Views-If-You-Don’t-Want-To-Use-CoW">Dealing with Views If You Don’t Want To Use CoW<a class=headerlink  href="#Dealing-with-Views-If-You-Don’t-Want-To-Use-CoW" title="Permalink to this headline">¶</a></h3> <p>I won’t mince words: I think this behavior deeply problematic, I’ve long advocated for it to be changed, and I’m fully on the Copy on Write train. But if for some reason you think you don’t need it…</p> <p><strong>SettingWithCopyWarning</strong></p> <p>To help address this issue, <code class="docutils literal notranslate"><span class=pre >pandas</span></code> has a built-in alert system that will <strong>sometimes</strong> warning you when you’re in a situation that may cause problems, called the <code class="docutils literal notranslate"><span class=pre >SettingWithCopyWarning</span></code>, which you can see here:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[12]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>

<span class=n >df</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >DataFrame</span><span class=p >({</span><span class=s2 >"a"</span><span class=p >:</span> <span class=n >np</span><span class=o >.</span><span class=n >arange</span><span class=p >(</span><span class=mi >4</span><span class=p >),</span> <span class=s2 >"b"</span><span class=p >:</span> <span class=p >[</span><span class=s2 >"w"</span><span class=p >,</span> <span class=s2 >"x"</span><span class=p >,</span> <span class=s2 >"y"</span><span class=p >,</span> <span class=s2 >"z"</span><span class=p >]})</span>
<span class=n >my_slice</span> <span class=o >=</span> <span class=n >df</span><span class=p >[</span><span class=s2 >"a"</span><span class=p >]</span>
<span class=n >my_slice</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[12]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
0    0
1    1
2    2
3    3
Name: a, dtype: int64
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[13]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >my_slice</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=o >=</span> <span class=mi >2</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area stderr docutils container"> <div class=highlight ><pre>
/var/folders/fs/h_8_rwsn5hvg9mhp0txgc_s9v6191b/T/ipykernel_64429/164737205.py:1: SettingWithCopyWarning:
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  my_slice.iloc[1] = 2
</pre></div></div> </div> <p>Any time you see a <code class="docutils literal notranslate"><span class=pre >SettingWithCopyWarning</span></code>, go up to where the possible view was created (in this case, <code class="docutils literal notranslate"><span class=pre >my_slice</span> <span class=pre >=</span> <span class=pre >df["a"]</span></code>) and add a <code class="docutils literal notranslate"><span class=pre >.copy()</span></code>:</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[14]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >my_slice</span> <span class=o >=</span> <span class=n >df</span><span class=p >[</span><span class=s2 >"a"</span><span class=p >]</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
<span class=n >my_slice</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >1</span><span class=p >]</span> <span class=o >=</span> <span class=mi >2</span>
</pre></div> </div> </div> <p><strong>The Problem with ``SettingWithCopyWarning``</strong></p> <p>The bad news is that the <code class="docutils literal notranslate"><span class=pre >SettingWithCopyWarning</span></code> will only flag one pattern where the copy-view problem crops up. Indeed, if you follow the link provided in the warning, you’ll see it wasn’t designed to address the copy-view problem <em>writ large</em>, but rather a more narrow behavior where the user tries to change a subset of a DataFrame incorrectly (we’ll talk more about that in our coming readings). Indeed, you’ll notice we didn’t get a single <code class="docutils literal notranslate"><span class=pre >SettingWithCopyWarning</span></code> until the section where we started talking about that warning in particular (and I created an example designed to set it off).</p> <p>So: if you see a <code class="docutils literal notranslate"><span class=pre >SettingWithCopyWarning</span></code> do <strong>not</strong> ignore it—find where you may have created a view or may have created a copy and add a <code class="docutils literal notranslate"><span class=pre >.copy()</span></code> so the error goes away. <strong>But just because you don’t see that warning doesn’t mean you’re in the clear!</strong></p> <p>Which leads me to what I will admit is an infuriating piece of advice to have to offer: <strong>if you take a subset for any purpose other than immediately analyzing, you should add .copy() to that subsetting.</strong> Seriously. Just when in doubt, <code class="docutils literal notranslate"><span class=pre >.copy()</span></code>.</p> </section> <section id="An-Aside:-No,-the-problem-doesn’t-only-emerge-when-you-change-the-data-type-of-a-column"> <h3 id="An-Aside:-No,-the-problem-doesn’t-only-emerge-when-you-change-the-data-type-of-a-column">An Aside: No, the problem doesn’t <em>only</em> emerge when you change the data type of a column<a class=headerlink  href="#An-Aside:-No,-the-problem-doesn’t-only-emerge-when-you-change-the-data-type-of-a-column" title="Permalink to this headline">¶</a></h3> <p>Some readers may have noticed a pattern in the illustrations I’ve presented, and from them developed an intuition that a column will only lose it’s “view-ness” when one changes the datatype of that column. Though this will always cause problems, it is not the only place problems can arise. What follows isn’t something you <em>need</em> to know, but may be useful if you’re deeply interested.</p> <p>In the examples above, each column was it’s own object, and so behaved independently. But this is not always the case in <code class="docutils literal notranslate"><span class=pre >pandas</span></code>. If a DataFrame is created from a single numpy matrix with multiple columns, <code class="docutils literal notranslate"><span class=pre >pandas</span></code> will try to be efficient by just keeping that matrix intact.</p> <p>But as a result, if you do something (like change the type) of <em>one</em> of the columns that is tied to that matrix, <code class="docutils literal notranslate"><span class=pre >pandas</span></code> will create new arrays to back <em>all</em> the columns that were once tied to the matrix. As a result, a view of a single column can stop being a view due to changes to a different column. For example:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[15]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >my_matrix</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >arange</span><span class=p >(</span><span class=mi >6</span><span class=p >)</span><span class=o >.</span><span class=n >reshape</span><span class=p >(</span><span class=mi >3</span><span class=p >,</span> <span class=mi >2</span><span class=p >)</span>
<span class=n >my_matrix</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[15]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
array([[0, 1],
       [2, 3],
       [4, 5]])
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[16]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=n >df</span> <span class=o >=</span> <span class=n >pd</span><span class=o >.</span><span class=n >DataFrame</span><span class=p >(</span><span class=n >my_matrix</span><span class=p >,</span> <span class=n >columns</span><span class=o >=</span><span class=p >[</span><span class=s2 >"a"</span><span class=p >,</span> <span class=s2 >"b"</span><span class=p >])</span>
<span class=n >df</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[16]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>0 <td>0 <td>1 <tr> <th>1 <td>2 <td>3 <tr> <th>2 <td>4 <td>5 </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[17]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Column_a starts of it's life as a view</span>
<span class=n >column_a</span> <span class=o >=</span> <span class=n >df</span><span class=p >[</span><span class=s2 >"a"</span><span class=p >]</span>
<span class=n >df</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >0</span><span class=p >,</span> <span class=mi >0</span><span class=p >]</span> <span class=o >=</span> <span class=o >-</span><span class=mi >42</span>
<span class=n >column_a</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[17]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
0   -42
1     2
2     4
Name: a, dtype: int64
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[18]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># But if I make a change to column b...</span>
<span class=n >df</span><span class=o >.</span><span class=n >loc</span><span class=p >[</span><span class=mi >0</span><span class=p >,</span> <span class=s2 >"b"</span><span class=p >]</span> <span class=o >=</span> <span class=s2 >"new entry"</span>
<span class=n >df</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[18]:
</pre></div> </div> <div class="output_area rendered_html docutils container"> <div> <style scoped=""> .dataframe tbody tr th:only-of-type { vertical-align: middle; } .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } </style> <table border=1  class=dataframe > <thead> <tr style="text-align: right;"> <th> <th>a <th>b <tr> <th>0 <td>-42 <td>new entry <tr> <th>1 <td>2 <td>3 <tr> <th>2 <td>4 <td>5 </table> </div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[19]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=c1 ># Then the same type of change to column a of `df` will no longer</span>
<span class=c1 ># be shared</span>

<span class=n >df</span><span class=o >.</span><span class=n >iloc</span><span class=p >[</span><span class=mi >0</span><span class=p >,</span> <span class=mi >0</span><span class=p >]</span> <span class=o >=</span> <span class=mi >999999</span>
<span class=n >column_a</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[19]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
0    999999
1         2
2         4
Name: a, dtype: int64
</pre></div></div> </div> <p>So, as noted before: it is best to never to try and infer whether a subset of a DataFrame if a view or a copy until you have <em>explicitly</em> made a copy with <code class="docutils literal notranslate"><span class=pre >.copy()</span></code>.</p> </section> </section> </section> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2021, Nick Eubank. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.5.0. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="../_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>