<!DOCTYPE html> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /><meta name=generator  content="Docutils 0.17.1: http://docutils.sourceforge.net/" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel=stylesheet > <style> body, input { font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif } code, kbd, pre { font-family: "Roboto Mono", "Courier New", Courier, monospace } </style> <link rel=stylesheet  href="../_static/stylesheets/application.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="../_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="../_static/fonts/material-icons.css"/> <meta name=theme-color  content="#2196f3"> <script src="../_static/javascripts/modernizr.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XX133829453-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-XX133829453-1'); </script> <title>Importing ARCOS Data with Dask &#8212; Practical Data Science</title> <link rel=stylesheet  type="text/css" href="../_static/pygments.css" /> <link rel=stylesheet  type="text/css" href="../_static/material.css" /> <script data-url_root="../" id=documentation_options  src="../_static/documentation_options.js"></script> <script src="../_static/jquery.js"></script> <script src="../_static/underscore.js"></script> <script src="../_static/doctools.js"></script> <script crossorigin=anonymous  integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script> <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script> <script defer=defer  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <link rel="shortcut icon" href="../_static/mids_logo.svg"/> <link rel=index  title=Index  href="../genindex.html" /> <link rel=search  title=Search  href="../search.html" /> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=blue> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#exercises/Exercise_dask_realdata" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href="../index.html" title="Practical Data Science" class="md-header-nav__button md-logo"> <img src="../_static/mids_logo.svg" height=26  alt="Practical Data Science logo"> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >Practical Data Science</span> <span class=md-header-nav__topic > Importing ARCOS Data with Dask </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action="../search.html" method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=Search  autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <script src="../_static/javascripts/version_dropdown.js"></script> <script> var json_loc = "../"versions.json"", target_loc = "../../", text = "Versions"; $( document ).ready( add_version_dropdown(json_loc, target_loc, text)); </script> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href="../index.html" class=md-tabs__link >Home</a> <li class=md-tabs__item ><a href="../class_schedule.html" class=md-tabs__link >Class Schedule</a> <li class=md-tabs__item ><a href="../topic_list.html" class=md-tabs__link >Topic List</a> <li class=md-tabs__item ><a href="https://www.nickeubank.com" class=md-tabs__link >About The Author</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href="../index.html" title="Practical Data Science" class="md-nav__button md-logo"> <img src="../_static/mids_logo.svg" alt=" logo" width=48  height=48 > </a> <a href="../index.html" title="Practical Data Science">Practical Data Science</a> </label> <ul class=md-nav__list > <li class=md-nav__item > <a href="../class_schedule.html" class=md-nav__link >Class Schedule</a> <li class=md-nav__item > <a href="../autograder_guidelines.html" class=md-nav__link >Autograder Guidelines</a> <li class=md-nav__item > <a href="Syllabus &lt;https://github.com/nickeubank/practicaldatascience/blob/master/syllabus/Syllabus_PracticalDataScience.pdf&gt;_" class=md-nav__link >Syllabus <https://github.com/nickeubank/practicaldatascience/blob/master/syllabus/Syllabus_PracticalDataScience.pdf>_</a> <li class=md-nav__item > <a href="../not_a_mids_student.html" class=md-nav__link >Not a MIDS Student?</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <label class=md-nav__title  for=__toc >Contents</label> <ul class=md-nav__list  data-md-scrollfix=""> <li class=md-nav__item ><a href="#exercises-exercise-dask-realdata--page-root" class=md-nav__link >Importing ARCOS Data with Dask</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Start-your-own-cluster!" class=md-nav__link >Start your own cluster!</a> <li class=md-nav__item ><a href="#Let’s-load-some-data!" class=md-nav__link >Let’s load some data!</a> </ul> </nav> </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <section id=Importing-ARCOS-Data-with-Dask > <h1 id=exercises-exercise-dask-realdata--page-root >Importing ARCOS Data with Dask<a class=headerlink  href="#exercises-exercise-dask-realdata--page-root" title="Permalink to this headline">¶</a></h1> <p>Today, we’re gonna do some of the manipulations you were doing over the last several weeks for your Opioid project, but now in dask!</p> <p>For familiarity, and so you can see what advantages dask can bring to your workflow, today we’ll be working with the DEA ARCOS drug shipment database published by the Washington Post! However, to strike a balance between size and speed, we’ll be working with a slightly thinned version that has only the last two years of data, instead of all six.</p> <section id="Start-your-own-cluster!"> <h2 id="Start-your-own-cluster!">Start your own cluster!<a class=headerlink  href="#Start-your-own-cluster!" title="Permalink to this headline">¶</a></h2> <p>dask has many backends, but the one that’s most versatile (and often most performant) is the <code class="docutils literal notranslate"><span class=pre >distributed</span></code> backend, so let’s use that here. Run:</p> <div class="highlight-python notranslate"><div class=highlight ><pre><span></span><span class=kn >from</span> <span class=nn >dask.distributed</span> <span class=kn >import</span> <span class=n >Client</span>
<span class=n >client</span> <span class=o >=</span> <span class=n >Client</span><span class=p >()</span>
<span class=n >client</span>
</pre></div> </div> <p>to create a set of workers on your computer. This cluster is running only on your own computer, but it operates exactly the way it would work on a cloud cluster where these workers live on other computers.</p> <p>When you type <code class="docutils literal notranslate"><span class=pre >client</span></code> in a jupyter notebook, you should see the <code class="docutils literal notranslate"><span class=pre >clusters</span></code> status pop up like this:</p> <img alt=dask_status  src="images/dask_status.png"/> <p>This status tells me that I have five processes running on my computer, each of which is running 2 threads (for 10 cores being used total). In addition, it tells me that the cluster sees that I have about 64GB of memory for it to play with.</p> <p>One cool thing you’ll see is that this panel includes a link to a Dashboard. Click this link, and a new tab will open in your browser that shows you, in real time, what your dask cluster is doing! We’ll come back to this later.</p> <p><strong>Note:</strong> these workers communication via networking protocols, so your firewall / anti-virus may ask if it’s ok to let Python accept connections (it is!).</p> <p>If you can’t get your system running, it may be due to your firewall / anti-virus. In that case, try <code class="docutils literal notranslate"><span class=pre >client</span> <span class=pre >=</span> <span class=pre >Client(processes=False)</span></code>. This will create four workers hiding in the same process (obviating the need for network protocols for communication between processes). Don’t worry if that last bit doesn’t make sense—those are implementation details you don’t have to worry about! :)</p> </section> <section id="Let’s-load-some-data!"> <h2 id="Let’s-load-some-data!">Let’s load some data!<a class=headerlink  href="#Let’s-load-some-data!" title="Permalink to this headline">¶</a></h2> <p><strong>(1)</strong> Download the thinned ARCOS data <a class="reference external" href="https://www.dropbox.com/s/o7nc6yvrwog4ozi/arcos_2011_2012.tsv.zip?dl=0">from this link</a>. It should be about 2GB zipped, 25 GB unzipped.</p> <p><strong>(2)</strong> Our goal today is going to be to find the pharmaceutical company that has shipped the most opioids (<code class="docutils literal notranslate"><span class=pre >MME_Conversion_Factor</span> <span class=pre >*</span> <span class=pre >CALC_BASE_WT_IN_GM</span></code>) in the US.</p> <p>When working with large datasets, it is good practice to begin by prototyping your code with a subset of your data. So begin by using <code class="docutils literal notranslate"><span class=pre >pandas</span></code> to read in the first 100,000 lines of the ARCOS data and write pandas code to compute the shipments from each shipper (the group that reported the shipment).</p> <p><strong>(3)</strong> Now let’s turn to dask. Re-write your code for dask, and calculate the total shipments by reporting company. Remember:</p> <ul class=simple > <li><p>Start by spinning up a cluster</p> <li><p>Dask won’t read compressed files, so you have to unzip your ARCOS data.</p> <li><p>Start your cluster in a cell all by itself since you don’t want to keep re-running the “start a cluster” code.</p> <li><p>Don’t load columns you don’t need!</p> </ul> <p>If you need to review dask basic code, <a class="reference internal" href="../distributed_computing.html"><span class=doc >check here</span></a>.</p> <p>As you run your code, make sure to click on the Dashboard link below where you created your cluster. Among other things, the bar across the bottom should give you a sense of how long your task will take:</p> <img alt=dask_progress  src="images/dask_progress.png"/> <p>Remember when you’re working with dask, nothing actually runs until you either run <code class="docutils literal notranslate"><span class=pre >.compute()</span></code>, or use a method that triggers immediate execution (like <code class="docutils literal notranslate"><span class=pre >.head()</span></code>, or a save function).</p> <p><strong>(4)</strong> Now let’s calculate, <em>for each state</em>, what company shipped the most pills?</p> <p>Note you will quickly find that you can’t sort in dask – sorting in parallel is <em>really</em> tricky! So you’ll have to work around that. Do what you need to do on the big dataset first, then run <code class="docutils literal notranslate"><span class=pre >.compute()</span></code> so you get the data returned as a regular pandas dataframe, then finish.</p> <p>Does this seem like a situation where a single company is responsible for the opioid epidemic?</p> <p><strong>(5)</strong> Now go ahead and try and re-do the chunking you did by hand for your project (with this 2 years of data)—calculate, for each year, the total morphine equivalents sent to each county in the US.</p> </section> </section> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2021, Nick Eubank. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.5.0. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="../_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>