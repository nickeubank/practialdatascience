<!DOCTYPE html> <meta charset=utf-8  /> <meta name=viewport  content="width=device-width, initial-scale=1.0" /><meta name=generator  content="Docutils 0.17.1: http://docutils.sourceforge.net/" /> <meta name=viewport  content="width=device-width,initial-scale=1"> <meta http-equiv=x-ua-compatible  content="ie=edge"> <meta name="lang:clipboard.copy" content="Copy to clipboard"> <meta name="lang:clipboard.copied" content="Copied to clipboard"> <meta name="lang:search.language" content=en > <meta name="lang:search.pipeline.stopwords" content=True > <meta name="lang:search.pipeline.trimmer" content=True > <meta name="lang:search.result.none" content="No matching documents"> <meta name="lang:search.result.one" content="1 matching document"> <meta name="lang:search.result.other" content="# matching documents"> <meta name="lang:search.tokenizer" content="[\s\-]+"> <link href="https://fonts.gstatic.com/" rel=preconnect  crossorigin> <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel=stylesheet > <style> body, input { font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif } code, kbd, pre { font-family: "Roboto Mono", "Courier New", Courier, monospace } </style> <link rel=stylesheet  href="_static/stylesheets/application.css"/> <link rel=stylesheet  href="_static/stylesheets/application-palette.css"/> <link rel=stylesheet  href="_static/stylesheets/application-fixes.css"/> <link rel=stylesheet  href="_static/fonts/material-icons.css"/> <meta name=theme-color  content="#2196f3"> <script src="_static/javascripts/modernizr.js"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XX133829453-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-XX133829453-1'); </script> <title>Speed in Python &#8212; Practical Data Science</title> <link rel=stylesheet  type="text/css" href="_static/pygments.css" /> <link rel=stylesheet  type="text/css" href="_static/material.css" /> <script data-url_root="./" id=documentation_options  src="_static/documentation_options.js"></script> <script src="_static/jquery.js"></script> <script src="_static/underscore.js"></script> <script src="_static/doctools.js"></script> <script crossorigin=anonymous  integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script> <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script> <script defer=defer  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <link rel="shortcut icon" href="_static/mids_logo.svg"/> <link rel=index  title=Index  href=genindex.html  /> <link rel=search  title=Search  href=search.html  /> <body dir=ltr data-md-color-primary=blue-grey data-md-color-accent=blue> <svg class=md-svg > <defs data-children-count=0 > <svg xmlns="http://www.w3.org/2000/svg" width=416  height=448  viewBox="0 0 416 448" id=__github ><path fill=currentColor  d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg> </defs> </svg> <input class=md-toggle  data-md-toggle=drawer  type=checkbox  id=__drawer > <input class=md-toggle  data-md-toggle=search  type=checkbox  id=__search > <label class=md-overlay  data-md-component=overlay  for=__drawer ></label> <a href="#performance_understanding" tabindex=1  class=md-skip > Skip to content </a> <header class=md-header  data-md-component=header > <nav class="md-header-nav md-grid"> <div class="md-flex navheader"> <div class="md-flex__cell md-flex__cell--shrink"> <a href=index.html  title="Practical Data Science" class="md-header-nav__button md-logo"> <img src="_static/mids_logo.svg" height=26  alt="Practical Data Science logo"> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer ></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title > <span class=md-header-nav__topic >Practical Data Science</span> <span class=md-header-nav__topic > Speed in Python </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search ></label> <div class=md-search  data-md-component=search  role=dialog > <label class=md-search__overlay  for=__search ></label> <div class=md-search__inner  role=search > <form class=md-search__form  action=search.html  method=get  name=search > <input type=text  class=md-search__input  name=q  placeholder=Search  autocapitalize=off  autocomplete=off  spellcheck=false  data-md-component=query  data-md-state=active > <label class="md-icon md-search__icon" for=__search ></label> <button type=reset  class="md-icon md-search__icon" data-md-component=reset  tabindex=-1 > &#xE5CD; </button> </form> <div class=md-search__output > <div class=md-search__scrollwrap  data-md-scrollfix> <div class=md-search-result  data-md-component=result > <div class=md-search-result__meta > Type to start searching </div> <ol class=md-search-result__list ></ol> </div> </div> </div> </div> </div> </div> <script src="_static/javascripts/version_dropdown.js"></script> <script> var json_loc = ""versions.json"", target_loc = "../", text = "Versions"; $( document ).ready( add_version_dropdown(json_loc, target_loc, text)); </script> </div> </nav> </header> <div class=md-container > <nav class=md-tabs  data-md-component=tabs > <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list > <li class=md-tabs__item ><a href=index.html  class=md-tabs__link >Home</a> <li class=md-tabs__item ><a href=class_schedule.html  class=md-tabs__link >Class Schedule</a> <li class=md-tabs__item ><a href=topic_list.html  class=md-tabs__link >Topic List</a> <li class=md-tabs__item ><a href="https://www.nickeubank.com" class=md-tabs__link >About The Author</a> </ul> </div> </nav> <main class=md-main > <div class="md-main__inner md-grid" data-md-component=container > <div class="md-sidebar md-sidebar--primary" data-md-component=navigation > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--primary" data-md-level=0 > <label class="md-nav__title md-nav__title--site" for=__drawer > <a href=index.html  title="Practical Data Science" class="md-nav__button md-logo"> <img src="_static/mids_logo.svg" alt=" logo" width=48  height=48 > </a> <a href=index.html  title="Practical Data Science">Practical Data Science</a> </label> <ul class=md-nav__list > <li class=md-nav__item > <a href=class_schedule.html  class=md-nav__link >Class Schedule</a> <li class=md-nav__item > <a href=autograder_guidelines.html  class=md-nav__link >Autograder Guidelines</a> <li class=md-nav__item > <a href=not_a_mids_student.html  class=md-nav__link >Not a MIDS Student?</a> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc > <div class=md-sidebar__scrollwrap > <div class=md-sidebar__inner > <nav class="md-nav md-nav--secondary"> <label class=md-nav__title  for=__toc >Contents</label> <ul class=md-nav__list  data-md-scrollfix=""> <li class=md-nav__item ><a href="#performance-understanding--page-root" class=md-nav__link >Speed in Python</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#The-Python-Ease-of-Use-/-Speed-Tradeoff" class=md-nav__link >The Python Ease of Use / Speed Tradeoff</a> <li class=md-nav__item ><a href="#Rules-for-Going-Fast-in-Python" class=md-nav__link >Rules for Going Fast in Python</a><nav class=md-nav > <ul class=md-nav__list > <li class=md-nav__item ><a href="#Rule-1:-Use-other-people’s-functions" class=md-nav__link >Rule 1: Use other people’s functions</a> <li class=md-nav__item ><a href="#Rule-2:-Vectorize,-Don’t-write-loops" class=md-nav__link >Rule 2: Vectorize, Don’t write loops</a> <li class=md-nav__item ><a href="#A-Note-On-Object-Vectors" class=md-nav__link >A Note On Object Vectors</a> </ul> </nav> <li class=md-nav__item ><a href="#Still-have-problems?" class=md-nav__link >Still have problems?</a> </ul> </nav> </ul> </nav> </div> </div> </div> <div class=md-content > <article class="md-content__inner md-typeset" role=main > <style> /* CSS for nbsphinx extension */ /* remove conflicting styling from Sphinx themes */ div.nbinput.container div.prompt *, div.nboutput.container div.prompt *, div.nbinput.container div.input_area pre, div.nboutput.container div.output_area pre, div.nbinput.container div.input_area .highlight, div.nboutput.container div.output_area .highlight { border: none; padding: 0; margin: 0; box-shadow: none; } div.nbinput.container > div[class*=highlight], div.nboutput.container > div[class*=highlight] { margin: 0; } div.nbinput.container div.prompt *, div.nboutput.container div.prompt * { background: none; } div.nboutput.container div.output_area .highlight, div.nboutput.container div.output_area pre { background: unset; } div.nboutput.container div.output_area div.highlight { color: unset; /* override Pygments text color */ } /* avoid gaps between output lines */ div.nboutput.container div[class*=highlight] pre { line-height: normal; } /* input/output containers */ div.nbinput.container, div.nboutput.container { display: -webkit-flex; display: flex; align-items: flex-start; margin: 0; width: 100%; } @media (max-width: 540px) { div.nbinput.container, div.nboutput.container { flex-direction: column; } } /* input container */ div.nbinput.container { padding-top: 5px; } /* last container */ div.nblast.container { padding-bottom: 5px; } /* input prompt */ div.nbinput.container div.prompt pre { color: #307FC1; } /* output prompt */ div.nboutput.container div.prompt pre { color: #BF5B3D; } /* all prompts */ div.nbinput.container div.prompt, div.nboutput.container div.prompt { width: 4.5ex; padding-top: 5px; position: relative; user-select: none; } div.nbinput.container div.prompt > div, div.nboutput.container div.prompt > div { position: absolute; right: 0; margin-right: 0.3ex; } @media (max-width: 540px) { div.nbinput.container div.prompt, div.nboutput.container div.prompt { width: unset; text-align: left; padding: 0.4em; } div.nboutput.container div.prompt.empty { padding: 0; } div.nbinput.container div.prompt > div, div.nboutput.container div.prompt > div { position: unset; } } /* disable scrollbars on prompts */ div.nbinput.container div.prompt pre, div.nboutput.container div.prompt pre { overflow: hidden; } /* input/output area */ div.nbinput.container div.input_area, div.nboutput.container div.output_area { -webkit-flex: 1; flex: 1; overflow: auto; } @media (max-width: 540px) { div.nbinput.container div.input_area, div.nboutput.container div.output_area { width: 100%; } } /* input area */ div.nbinput.container div.input_area { border: 1px solid #e0e0e0; border-radius: 2px; /*background: #f5f5f5;*/ } /* override MathJax center alignment in output cells */ div.nboutput.container div[class*=MathJax] { text-align: left !important; } /* override sphinx.ext.imgmath center alignment in output cells */ div.nboutput.container div.math p { text-align: left; } /* standard error */ div.nboutput.container div.output_area.stderr { background: #fdd; } /* ANSI colors */ .ansi-black-fg { color: #3E424D; } .ansi-black-bg { background-color: #3E424D; } .ansi-black-intense-fg { color: #282C36; } .ansi-black-intense-bg { background-color: #282C36; } .ansi-red-fg { color: #E75C58; } .ansi-red-bg { background-color: #E75C58; } .ansi-red-intense-fg { color: #B22B31; } .ansi-red-intense-bg { background-color: #B22B31; } .ansi-green-fg { color: #00A250; } .ansi-green-bg { background-color: #00A250; } .ansi-green-intense-fg { color: #007427; } .ansi-green-intense-bg { background-color: #007427; } .ansi-yellow-fg { color: #DDB62B; } .ansi-yellow-bg { background-color: #DDB62B; } .ansi-yellow-intense-fg { color: #B27D12; } .ansi-yellow-intense-bg { background-color: #B27D12; } .ansi-blue-fg { color: #208FFB; } .ansi-blue-bg { background-color: #208FFB; } .ansi-blue-intense-fg { color: #0065CA; } .ansi-blue-intense-bg { background-color: #0065CA; } .ansi-magenta-fg { color: #D160C4; } .ansi-magenta-bg { background-color: #D160C4; } .ansi-magenta-intense-fg { color: #A03196; } .ansi-magenta-intense-bg { background-color: #A03196; } .ansi-cyan-fg { color: #60C6C8; } .ansi-cyan-bg { background-color: #60C6C8; } .ansi-cyan-intense-fg { color: #258F8F; } .ansi-cyan-intense-bg { background-color: #258F8F; } .ansi-white-fg { color: #C5C1B4; } .ansi-white-bg { background-color: #C5C1B4; } .ansi-white-intense-fg { color: #A1A6B2; } .ansi-white-intense-bg { background-color: #A1A6B2; } .ansi-default-inverse-fg { color: #FFFFFF; } .ansi-default-inverse-bg { background-color: #000000; } .ansi-bold { font-weight: bold; } .ansi-underline { text-decoration: underline; } div.nbinput.container div.input_area div[class*=highlight] > pre, div.nboutput.container div.output_area div[class*=highlight] > pre, div.nboutput.container div.output_area div[class*=highlight].math, div.nboutput.container div.output_area.rendered_html, div.nboutput.container div.output_area > div.output_javascript, div.nboutput.container div.output_area:not(.rendered_html) > img{ padding: 5px; margin: 0; } /* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */ div.nbinput.container div.input_area > div[class^='highlight'], div.nboutput.container div.output_area > div[class^='highlight']{ overflow-y: hidden; } /* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */ .prompt .copybtn { display: none; } /* Some additional styling taken form the Jupyter notebook CSS */ .jp-RenderedHTMLCommon table, div.rendered_html table { border: none; border-collapse: collapse; border-spacing: 0; color: black; font-size: 12px; table-layout: fixed; } .jp-RenderedHTMLCommon thead, div.rendered_html thead { border-bottom: 1px solid black; vertical-align: bottom; } .jp-RenderedHTMLCommon tr, .jp-RenderedHTMLCommon th, .jp-RenderedHTMLCommon td, div.rendered_html tr, div.rendered_html th, div.rendered_html td { text-align: right; vertical-align: middle; padding: 0.5em 0.5em; line-height: normal; white-space: normal; max-width: none; border: none; } .jp-RenderedHTMLCommon th, div.rendered_html th { font-weight: bold; } .jp-RenderedHTMLCommon tbody tr:nth-child(odd), div.rendered_html tbody tr:nth-child(odd) { background: #f5f5f5; } .jp-RenderedHTMLCommon tbody tr:hover, div.rendered_html tbody tr:hover { background: rgba(66, 165, 245, 0.2); } </style> <section id=Speed-in-Python > <h1 id=performance-understanding--page-root >Speed in Python<a class=headerlink  href="#performance-understanding--page-root" title="Permalink to this headline">¶</a></h1> <p>First, the good news: as a Data Scientist working in Python, <em>most</em> of the time whatever libraries you want to use have already been carefully engineered to deliver amazing performance, meaning working about code speed is something you <em>usually</em> won’t have to worry about. But understanding why programs like Python can sometimes be slow is still important for being able to avoid accidentally writing code that runs so slowly you can’t get your work done, and for trouble shooting if you end up in a situation where you really need something to go faster.</p> <section id="The-Python-Ease-of-Use-/-Speed-Tradeoff"> <h2 id="The-Python-Ease-of-Use-/-Speed-Tradeoff">The Python Ease of Use / Speed Tradeoff<a class=headerlink  href="#The-Python-Ease-of-Use-/-Speed-Tradeoff" title="Permalink to this headline">¶</a></h2> <p>There are two primary factors that determine the speed of a program:</p> <ul class=simple > <li><p>The number of computations computer has to complete (i.e. adding, multiplying, etc.)</p> <li><p>The amount it has to access and move data around (as discussed in <a class="reference internal" href=what_is_big_data.html ><span class=doc >What Is Big Data?</span></a>, memory access is <strong>slow</strong>).</p> </ul> <p>This is obviously kinda abstract, so let’s look at some real code and discuss what you computer is actually doing when it runs Python code. In particular, let’s focus on what happens in a loop like this:</p> <div class="highlight-python notranslate"><div class=highlight ><pre><span></span><span class=n >summation</span> <span class=o >=</span> <span class=mi >0</span>
<span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=nb >range</span><span class=p >(</span><span class=mi >1000</span><span class=p >):</span>
    <span class=n >summation</span> <span class=o >=</span> <span class=n >summation</span> <span class=o >+</span> <span class=n >i</span>
</pre></div> </div> <p>Now, you might think that all Python has to do to run this loop is add a bunch of numbers. But unfortunately, that’s not the case.</p> <p>At each step of this loop, Python has to do the following:</p> <ol class="arabic simple"> <li><p>Dereference <code class="docutils literal notranslate"><span class=pre >summation</span></code> (find the place in memory that is associated with the variable <code class="docutils literal notranslate"><span class=pre >summation</span></code> and read the data there)</p> <li><p>Read that data to figure out the <code class="docutils literal notranslate"><span class=pre >type</span></code> of <code class="docutils literal notranslate"><span class=pre >summation</span></code> (in this case, it’s an integer).</p> <li><p>Dereference <code class="docutils literal notranslate"><span class=pre >i</span></code></p> <li><p>Read that data to figure out the <code class="docutils literal notranslate"><span class=pre >type</span></code> of <code class="docutils literal notranslate"><span class=pre >i</span></code> (in this case, it’s an integer).</p> <li><p>Lookup how it should interpret <code class="docutils literal notranslate"><span class=pre >+</span></code> given that <code class="docutils literal notranslate"><span class=pre >summation</span></code> is an integer and <code class="docutils literal notranslate"><span class=pre >i</span></code> is an integer.</p> <ul class=simple > <li><p>Remember: if <code class="docutils literal notranslate"><span class=pre >summation</span></code> and <code class="docutils literal notranslate"><span class=pre >i</span></code> were strings, it wouldn’t be doing addition, it would be concatenating! And because integers and floating point numbers are different things from the perspective of a computer, if <code class="docutils literal notranslate"><span class=pre >i</span></code> were an integer and <code class="docutils literal notranslate"><span class=pre >summation</span></code> were a floating point number, <code class="docutils literal notranslate"><span class=pre >+</span></code> would actually require (a) converting <code class="docutils literal notranslate"><span class=pre >i</span></code> to a floating point number, then (b) adding the floating point version of <code class="docutils literal notranslate"><span class=pre >i</span></code> to <code class="docutils literal notranslate"><span class=pre >summation</span></code>.</p> </ul> <li><p>Compile low-level binary code (referred to as “machine code”) that can be read by the computer’s processor to tell it to execute an addition of two integers AND to also check and make sure that the operation won’t cause an integer overflow (<a class="reference external" href=ints_and_floats.ipynb >remember: Python checks for integer overflows!</a> That’s another operation!).</p> <li><p>Run that code.</p> </ol> <p>As you can see, there’s a <em>lot</em> going on in that simple line of code, and that process has to repeat <em>every step of the loop</em>.</p> <p>Now, you might ask, is all of that necessary?</p> <p>The answer is both yes and no. There are languages that don’t require all those steps (like C and C++, the standard-bearers for speed), but if Python didn’t do all those things when it ran, you wouldn’t be able to use Python the way you do.</p> <p>Python is designed to be easy for you, the programmer. Unlike in some languages (like C), in Python you don’t have to declare that <code class="docutils literal notranslate"><span class=pre >i</span></code> is an integer explicitly in your code, and you are allowed to change <code class="docutils literal notranslate"><span class=pre >i</span></code> from an integer to a floating point number whenever you want. That makes Python what’s called a <strong>dynamically typed</strong> language, and it makes it very easy to use. If you wrote this in C, every time you made a new variable you’d have to declare it’s type. But the fact it’s dynamically typed means the language is never quite sure of the type of a variable until it explicitly checks that type, because it could change at any time.</p> <p>Moreover, Python is a language you can use <em>interactively</em>. You can’t open a terminal and write and execute C code one line at a time. For languages like C (what are called “compiled languages”), you write all of your code, then hit compile, and your computer reads all your code and compiles low-level binary code for that entire program at once. Then the only way to use your C code is to run that compiled program. But the advantage of that is that step 6 (compiling your code) is done once in advance, and you don’t have to do that every time you run your code.</p> <p>But to make Python interactive, it was decided that Python should evaluate each line of code when it reaches that code. That massively increases it’s flexibility and allows you to program interactively, but for loops like this, it means to do 1,000 additions, it also has to compile low-level machine code 1,000 times. (Note: there are newer languages like <a class="reference external" href="https://julialang.org/">Julia</a> that have are still interactive, but which are also smart enough to recognize these situations and only compile machine code once. Moreover, these languages also reduce the amount of “dereferencing” required. But that’s not Python.)</p> </section> <section id=Rules-for-Going-Fast-in-Python > <h2 id=Rules-for-Going-Fast-in-Python >Rules for Going Fast in Python<a class=headerlink  href="#Rules-for-Going-Fast-in-Python" title="Permalink to this headline">¶</a></h2> <p>So now that you have some sense of why Python can be slow, let’s talk about how to keep your Python code fast (note to R users: basically everything I say here about Python also applies to R):</p> <section id="Rule-1:-Use-other-people’s-functions"> <h3 id="Rule-1:-Use-other-people’s-functions">Rule 1: Use other people’s functions<a class=headerlink  href="#Rule-1:-Use-other-people’s-functions" title="Permalink to this headline">¶</a></h3> <p>Let’s start with the dirty secret of Python: when you use a library in Python, the code you’re running was almost never actually written in Python. Instead, the functions you’re calling have a “thin” layer of Python at the top (which is what you’re interacting with), but when it comes to doing serious computations, the functions are actually calling tools written in C, which is <em>blazing</em> fast. (This is also true of R, by the way).</p> <p>Thus the first rule of speed in Python: when you need speed, use tools that other people have written and distributed in big libraries (like <code class="docutils literal notranslate"><span class=pre >pandas</span></code>, <code class="docutils literal notranslate"><span class=pre >sci-py</span></code>, <code class="docutils literal notranslate"><span class=pre >statsmodels</span></code>, etc.). Because what you’re really doing is using C, and C is 10s or 100s of times faster than Python.</p> </section> <section id="Rule-2:-Vectorize,-Don’t-write-loops"> <h3 id="Rule-2:-Vectorize,-Don’t-write-loops">Rule 2: Vectorize, Don’t write loops<a class=headerlink  href="#Rule-2:-Vectorize,-Don’t-write-loops" title="Permalink to this headline">¶</a></h3> <p>When you use “vectorized” code (meaning code where you interact two full vectors or matrices in one command instead of looping over elements), you get <em>huge</em> performance gains. For example, consider the performance differences between the following two blocks of code, both of which do <em>exactly the same thing</em>:</p> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[6]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
<span class=n >numbers</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >arange</span><span class=p >(</span><span class=mi >1000000</span><span class=p >)</span>
<span class=n >numbers</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[6]:
</pre></div> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
array([     0,      1,      2, ..., 999997, 999998, 999999])
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[8]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=o >%%time</span>it
<span class=c1 ># Make a new array where each number is doubled</span>
<span class=c1 ># done with a loop</span>
<span class=n >b</span> <span class=o >=</span> <span class=n >numbers</span><span class=o >.</span><span class=n >copy</span><span class=p >()</span>
<span class=k >for</span> <span class=n >i</span> <span class=ow >in</span> <span class=nb >range</span><span class=p >(</span><span class=nb >len</span><span class=p >(</span><span class=n >b</span><span class=p >)):</span>
    <span class=n >b</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >=</span> <span class=n >numbers</span><span class=p >[</span><span class=n >i</span><span class=p >]</span> <span class=o >*</span> <span class=mi >2</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
357 ms ± 10.3 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[10]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=o >%%time</span>it
<span class=c1 ># Now vectorized</span>
<span class=n >b</span> <span class=o >=</span> <span class=n >numbers</span> <span class=o >*</span> <span class=mi >2</span>
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
1.09 ms ± 40.6 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre></div></div> </div> <p>That’s a <em>300x</em> speedup! For the exact same code!!!!</p> <p>OK, so why does this happen?</p> <p>The answer is twofold.</p> <p>First, when Python dereferences a variable (i.e. get the object associated with a variable), there are actually two steps to that process: first, Python must look up where to find the object in memory; then second it must go get the object.</p> <p>Because Python evaluates every line of code when it reaches that line, in the loop example, in ever step of the loop Python has to look up where to find the array, then go get the array value.</p> <p>But in the vectorized function, Python (or rather, the <code class="docutils literal notranslate"><span class=pre >numpy</span></code> code written in C that gets called) is designed to understand that it’s about to do something to every entry of an array, so it remembers where the array is located, and so only has to look up where to find the array once.</p> <p>In addition, arrays are <em>typed</em>, meaning that Python also knows that every entry of the array it’s modifying is an integer. As a result, it doesn’t have to check the type of every entry in the array when the operation is vectorized, it checks once and knows that it’s working with an array of integers.</p> <p>(You may say “but can’t it do the same in the loop?” In theory it could, and there are languages like Julia that are designed to be smarter about this kind of stuff. But currently, because Python only evaluates a line of code when it is reached means that it can be frustratingly myopic.)</p> </section> <section id=A-Note-On-Object-Vectors > <h3 id=A-Note-On-Object-Vectors >A Note On Object Vectors<a class=headerlink  href="#A-Note-On-Object-Vectors" title="Permalink to this headline">¶</a></h3> <p>You now also know enough to understand why object vectors in numpy and pandas are less performant.</p> <p>When you’re working with a pandas Series or numpy array of integers, all of the entries of those arrays live in the same place in memory. This is because it is easy for a computer to put, say, 100 integers side by side, since it knows that each integer requires exactly 64 bits and so it can put them all end to end and tell the computer that each number starts 64 bits after the last.</p> <p>But an <em>object</em> array is a little different. Instead of laying all the contents of the array in one place, an object array puts a collection of <em>memory addresses</em> in one place. This is because objects can be of arbitrary size, so you can’t put them all in one place in memory reliably. For example, suppose you had an array that had the following strings: <code class="docutils literal notranslate"><span class=pre >'this'</span></code>, <code class="docutils literal notranslate"><span class=pre >'is'</span></code>, <code class="docutils literal notranslate"><span class=pre >'an'</span></code>, <code class="docutils literal notranslate"><span class=pre >'array'</span></code>. The first entry is longer than the second, is the same as the third, and is shorter than the third. You can’t just put them end-to-end and tell the computer “each number starts X bits after the last”.</p> <p>But you can do that with memory addresses. So an object array is a collection of memory addresses (each the same size) laid end to end.</p> <p>But that means that to look at the second entry of an object array, you have to go to the second location in the array, read the address, <em>then go to that address.</em> Moreover, because object arrays can hold anything, you could have an integer in the first entry, and a string in the second entry, so you can’t assume that when you see code like:</p> <div class="highlight-python notranslate"><div class=highlight ><pre><span></span><span class=n >my_array</span> <span class=o >*</span> <span class=mi >2</span>
</pre></div> </div> <p>that <code class="docutils literal notranslate"><span class=pre >*</span></code> will mean the same thing for each entry. In one entry, you might be doing integer multiplication; in another you might be doing floating point multiplication, in another you may be doubling up a list!</p> <p>Indeed we can see this is we make a numpy object array full of ints and compare it to a numpy integer array. The both have the same content, but they are organized in memory differently:</p> <div class="nbinput nblast docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[13]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=kn >import</span> <span class=nn >numpy</span> <span class=k >as</span> <span class=nn >np</span>
<span class=n >object_numbers</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >array</span><span class=p >(</span><span class=n >np</span><span class=o >.</span><span class=n >arange</span><span class=p >(</span><span class=mi >1000000</span><span class=p >),</span><span class=n >dtype</span><span class=o >=</span><span class=s1 >'object'</span><span class=p >)</span>
<span class=n >numbers</span> <span class=o >=</span> <span class=n >np</span><span class=o >.</span><span class=n >arange</span><span class=p >(</span><span class=mi >1000000</span><span class=p >)</span>
</pre></div> </div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[17]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=o >%</span><span class=k >timeit</span> object_numbers * 2
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
27.6 ms ± 1.1 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div></div> </div> <div class="nbinput docutils container"> <div class="prompt highlight-none notranslate"><div class=highlight ><pre><span></span>[18]:
</pre></div> </div> <div class="input_area highlight-ipython3 notranslate"><div class=highlight ><pre><span></span><span class=o >%</span><span class=k >timeit</span> numbers * 2
</pre></div> </div> </div> <div class="nboutput nblast docutils container"> <div class="prompt empty docutils container"> </div> <div class="output_area docutils container"> <div class=highlight ><pre>
1.11 ms ± 49 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre></div></div> </div> <p>See? Same operation (doubling each entry of arrays with the integers from 0 to 1,000,000), but the object array operation is ~25x slower.</p> </section> </section> <section id="Still-have-problems?"> <h2 id="Still-have-problems?">Still have problems?<a class=headerlink  href="#Still-have-problems?" title="Permalink to this headline">¶</a></h2> <p>Check out more <a class="reference internal" href=performance_solutions.html ><span class=doc >advanced performance solutions</span></a>!</p> </section> </section> </article> </div> </div> </main> </div> <footer class=md-footer > <div class=md-footer-nav > <nav class="md-footer-nav__inner md-grid"> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright > <div class=md-footer-copyright__highlight > &#169; Copyright 2021, Nick Eubank. </div> Created using <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.5.0. and <a href="https://github.com/bashtage/sphinx-material/">Material for Sphinx</a> </div> </div> </div> </footer> <script src="_static/javascripts/application.js"></script> <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>